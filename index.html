<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Toulon — Clock & Weather</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;600&display=swap" rel="stylesheet">

  <style>
    :root {
      --glass: rgba(16, 22, 40, 0.76);
      --glass-strong: rgba(14, 20, 40, 0.84);
      --border: rgba(255, 255, 255, 0.2);
      --text: #f5f7ff;
      --muted: #d4d9ee;
      --muted-strong: #e6ebf9;
      --accent: #7fe7ff;
      --accent-strong: #59d2ff;
      --accent-secondary: #b48cff;
      --shadow: 0 16px 36px rgba(0, 0, 0, 0.38);
      --card-radius: 18px;
      --card-gap: 18px;
      --blur: blur(22px);
      --glow: 0 0 30px rgba(116, 211, 255, 0.18);

      --icon-stroke: #d8dee9;
      --icon-cloud: #c7d1e2;
      --icon-rain: #86dcff;
      --icon-sun: #ffd36b;
      --icon-wind: #71e0e2;
      --icon-uv: #c79cff;
      --icon-humidity: #8acbff;
      --icon-pressure: #a9b4c8;
      --icon-night: #bda8ff;
      --icon-location: #7fe7ff;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      background: radial-gradient(circle at 12% 8%, #1a2750 0%, #0b1226 45%, #060812 100%);
      min-height: 100vh;
      overflow-x: hidden;
    }

    .galaxy {
      position: fixed;
      inset: 0;
      z-index: -2;
      background:
        radial-gradient(1000px 560px at 78% 8%, rgba(120, 140, 255, 0.24), transparent 78%),
        radial-gradient(920px 500px at 12% 86%, rgba(255, 90, 200, 0.2), transparent 82%),
        radial-gradient(720px 420px at 48% 38%, rgba(110, 230, 255, 0.18), transparent 82%),
        radial-gradient(680px 420px at 22% 28%, rgba(210, 120, 255, 0.2), transparent 84%),
        radial-gradient(660px 360px at 72% 70%, rgba(255, 80, 120, 0.2), transparent 86%),
        radial-gradient(820px 460px at 62% 18%, rgba(214, 74, 255, 0.18), transparent 82%),
        radial-gradient(840px 520px at 35% 60%, rgba(255, 120, 120, 0.18), transparent 85%),
        radial-gradient(780px 480px at 68% 46%, rgba(255, 60, 140, 0.16), transparent 85%),
        radial-gradient(1200px 800px at 50% 50%, rgba(10, 14, 30, 0.9), rgba(5, 7, 16, 0.98));
      filter: saturate(1.25);
    }

    canvas#stars {
      position: fixed;
      inset: 0;
      z-index: -1;
      opacity: 0.62;
      pointer-events: none;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 28px;
    }

    .header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      margin-bottom: 18px;
      gap: 12px;
    }

    .title {
      font-size: 1.45rem;
      font-weight: 600;
      letter-spacing: 0.4px;
    }

    .last-updated {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.18);
      border: 1px solid rgba(255, 255, 255, 0.26);
      color: var(--muted-strong);
      font-size: 0.9rem;
      font-weight: 650;
      letter-spacing: 0.2px;
      white-space: nowrap;
      box-shadow: inset 0 0 12px rgba(255, 255, 255, 0.06);
    }

    .last-updated svg {
      width: 16px;
      height: 16px;
      color: var(--accent-strong);
      display: block;
    }

    .last-updated span {
      color: var(--accent);
    }

    .unit-toggle {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.18);
      border: 1px solid rgba(255, 255, 255, 0.26);
      box-shadow: inset 0 0 12px rgba(255, 255, 255, 0.06);
    }

    .unit-toggle button {
      border: none;
      background: transparent;
      color: var(--muted-strong);
      font-size: 0.82rem;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 999px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .unit-toggle button.active {
      background: rgba(127, 231, 255, 0.25);
      color: var(--accent);
      box-shadow: 0 0 10px rgba(127, 231, 255, 0.2);
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1fr) minmax(0, 0.9fr);
      gap: 24px;
      align-items: stretch;
    }

    .left-col,
    .right-col {
      display: grid;
      gap: var(--card-gap);
      align-content: start;
      height: 100%;
    }

    .right-col {
      width: 100%;
      max-width: 560px;
      margin-left: auto;
    }

    .card {
      background: var(--glass);
      border: 1px solid var(--border);
      border-radius: var(--card-radius);
      box-shadow: var(--shadow);
      backdrop-filter: var(--blur);
      -webkit-backdrop-filter: var(--blur);
      padding: 18px 20px;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      min-height: 96px;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 34px rgba(0, 0, 0, 0.32);
    }

    .clock-wrap {
      display: grid;
      place-items: center;
      gap: 14px;
    }

    .analog {
      width: 230px;
      height: 230px;
      border-radius: 50%;
      background: radial-gradient(circle at 50% 40%, rgba(255,255,255,0.16), rgba(255,255,255,0.03));
      border: 1px solid rgba(255,255,255,0.28);
      position: relative;
      box-shadow: var(--glow), inset 0 0 18px rgba(255, 255, 255, 0.08);
    }

    .tick {
      position: absolute;
      width: 2px;
      height: 11px;
      background: rgba(255,255,255,0.5);
      top: 6px;
      left: 50%;
      transform-origin: 50% 110px;
    }

    .tick.major {
      height: 18px;
      background: rgba(255,255,255,0.9);
    }

    .hand {
      position: absolute;
      left: 50%;
      top: 50%;
      transform-origin: 0% 50%;
      transform: rotate(90deg);
      border-radius: 6px;
      transition: transform 0.4s cubic-bezier(0.4, 0.8, 0.2, 1);
    }

    .hand.hour {
      width: 64px;
      height: 6px;
      background: linear-gradient(90deg, #ffffff, #8cd6ff);
      box-shadow: 0 0 8px rgba(140, 214, 255, 0.35);
    }

    .hand.minute {
      width: 96px;
      height: 4px;
      background: linear-gradient(90deg, #ffffff, #bfeaff);
      box-shadow: 0 0 8px rgba(140, 214, 255, 0.28);
    }

    .hand.second {
      width: 108px;
      height: 2px;
      background: var(--accent-secondary);
      box-shadow: 0 0 10px rgba(180, 140, 255, 0.4);
      transition: transform 0.15s linear;
    }

    .center-dot {
      position: absolute;
      width: 11px;
      height: 11px;
      background: #fff;
      border-radius: 50%;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      box-shadow: 0 0 10px rgba(255,255,255,0.5);
    }

    .clock-number {
      position: absolute;
      font-size: 0.95rem;
      color: #f0f3ff;
      font-weight: 650;
      letter-spacing: 0.4px;
      transform: translate(-50%, -50%);
      user-select: none;
      pointer-events: none;
      text-shadow: 0 2px 6px rgba(9, 12, 24, 0.6);
    }

    .digital { text-align: center; }

    .digital-time {
      font-size: 2.6rem;
      font-weight: 700;
      letter-spacing: 2px;
      color: var(--accent);
    }

    .digital-time .seconds {
      font-size: 1.4rem;
      color: var(--muted);
    }

    .blink {
      display: inline-block;
      animation: blink 1s infinite ease-in-out;
    }

    @keyframes blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0.2; }
    }

    .digital-date {
      margin-top: 6px;
      color: var(--muted);
      font-size: 1rem;
    }

    .sun-row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: var(--card-gap);
      align-items: stretch;
    }

    .sun-row .card {
      height: 100%;
    }

    .mini-forecast { display: grid; gap: 12px; }

    .mini-forecast-row {
      display: grid;
      grid-template-columns: repeat(6, minmax(0, 1fr));
      gap: 10px;
      align-items: stretch;
    }

    .mini-item {
      display: grid;
      grid-template-rows: auto 40px auto auto;
      justify-items: center;
      gap: 6px;
      padding: 12px 8px 10px;
      border-radius: 14px;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.14);
      text-align: center;
    }

    .mini-icon {
      display: grid;
      place-items: center;
      width: 40px;
      height: 40px;
    }

    .mini-icon svg {
      width: 30px;
      height: 30px;
      display: block;
    }

    .mini-time {
      font-size: 0.8rem;
      color: var(--muted-strong);
      font-weight: 600;
      white-space: nowrap;
      letter-spacing: 0.2px;
    }

    .mini-time .ampm {
      font-size: 0.62rem;
      letter-spacing: 0.4px;
      margin-left: 2px;
      opacity: 0.9;
    }

    .mini-temp {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--accent);
    }

    .mini-precip {
      font-size: 0.7rem;
      color: var(--accent-secondary);
    }

    .mini-marker {
      font-size: 0.62rem;
      color: #ffd36b;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.4px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(255, 211, 107, 0.14);
      border: 1px solid rgba(255, 211, 107, 0.3);
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: var(--card-gap);
    }

    .bottom-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: var(--card-gap);
      align-items: stretch;
      grid-auto-rows: minmax(0, 1fr);
    }

    .bottom-grid .card {
      height: 100%;
      min-height: 230px;
    }

    .weather-card {
      display: grid;
      gap: 6px;
      align-content: center;
    }

    .summary-content {
      display: grid;
      gap: 8px;
    }

    .summary-timeline {
      display: grid;
      gap: 6px;
      margin-top: 8px;
      width: 100%;
    }

    .summary-timeline-line {
      height: 1px;
      background-color: rgba(255, 255, 255, 0.18);
      position: relative;
      border-radius: 999px;
      margin: 0;
      background-image: linear-gradient(90deg, rgba(255, 255, 255, 0.45) 1px, transparent 1px);
      background-size: calc(100% / 4) 100%;
      background-repeat: repeat-x;
    }

    .summary-timeline-labels {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      font-size: 0.8rem;
      color: var(--muted-strong);
      letter-spacing: 0.2px;
      text-align: center;
      white-space: nowrap;
      font-weight: 600;
    }

    .weather-title {
      font-size: 0.9rem;
      color: var(--muted-strong);
      letter-spacing: 0.2px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      text-transform: uppercase;
      font-weight: 600;
      line-height: 1;
      min-height: 22px;
 encourages consistent header alignment */
    }

    .weather-subtitle {
      font-size: 0.8rem;
      color: var(--muted);
      letter-spacing: 0.2px;
      font-weight: 500;
      text-transform: none;
    }

    .weather-value {
      font-size: 1.6rem;
      font-weight: 600;
      color: var(--accent);
    }

    .condition-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .condition-icon {
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex: 0 0 44px;
    }

    .condition-icon svg {
      width: 38px;
      height: 38px;
      display: block;
    }

    .condition-text {
      display: flex;
      align-items: center;
      min-height: 44px;
      font-weight: 600;
      font-size: 1.05rem;
      color: var(--accent);
      line-height: 1;
      transform: translateY(1px);
    }

    .sun-card {
      display: grid;
      gap: 14px;
    }

    .sun-card-header {
      display: grid;
      gap: 6px;
    }

    .sun-card-time {
      font-size: 1.9rem;
      font-weight: 650;
      color: var(--accent);
      letter-spacing: 0.6px;
    }

    .sun-card-sub {
      font-size: 0.85rem;
      color: var(--muted);
    }

    .sun-grid {
      position: relative;
      padding: 14px 12px 10px;
      border-radius: 14px;
      background:
        linear-gradient(90deg, rgba(255, 255, 255, 0.12) 1px, transparent 1px) 0 0 / 25% 100%,
        linear-gradient(180deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.02));
      border: 1px solid rgba(255, 255, 255, 0.15);
    }

    .sun-grid-labels {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      margin-top: 6px;
      font-size: 0.72rem;
      color: var(--muted-strong);
      letter-spacing: 0.3px;
    }

    .sun-grid-labels span {
      text-align: center;
    }

    .sun-curve {
      width: 100%;
      height: 52px;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .moon-card {
      display: grid;
      gap: 14px;
    }

    .moon-visual {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .moon-icon-large {
      width: 58px;
      height: 58px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.35), rgba(200,200,255,0.08));
      display: grid;
      place-items: center;
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: var(--icon-night);
      box-shadow: inset 0 0 12px rgba(255, 255, 255, 0.12);
    }

    .moon-icon-large svg {
      width: 34px;
      height: 34px;
      display: block;
    }

    .moon-phase-label {
      font-size: 0.95rem;
      color: var(--muted-strong);
      font-weight: 600;
    }

    .moon-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px 14px;
      font-size: 0.8rem;
      color: var(--muted-strong);
    }

    .moon-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      white-space: nowrap;
    }

    .moon-grid span:last-child {
      color: var(--text);
      font-weight: 600;
    }

    .wind-compass {
      width: 86px;
      height: 86px;
      border-radius: 50%;
      border: 1px solid rgba(255, 255, 255, 0.2);
      display: grid;
      place-items: center;
      position: relative;
      margin-top: 10px;
      background: radial-gradient(circle at center, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
    }

    .wind-compass-label {
      position: absolute;
      font-size: 0.65rem;
      color: var(--muted-strong);
      font-weight: 600;
    }

    .wind-compass-label.n { top: 6px; }
    .wind-compass-label.e { right: 8px; }
    .wind-compass-label.s { bottom: 6px; }
    .wind-compass-label.w { left: 8px; }

    .wind-compass-needle {
      width: 2px;
      height: 28px;
      background: var(--accent);
      border-radius: 999px;
      transform-origin: bottom center;
      box-shadow: 0 0 8px rgba(127, 231, 255, 0.5);
    }

    .wind-compass-needle::after {
      content: "";
      position: absolute;
      top: -6px;
      left: 50%;
      width: 8px;
      height: 8px;
      border-radius: 2px;
      background: var(--accent);
      transform: translateX(-50%) rotate(45deg);
    }

    .metric-icon {
      width: 18px;
      height: 18px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: var(--icon-stroke);
      flex: 0 0 auto;
    }

    .metric-icon svg {
      width: 18px;
      height: 18px;
      display: block;
    }

    .metric-icon.sun { color: var(--icon-sun); }
    .metric-icon.cloud { color: var(--icon-cloud); }
    .metric-icon.rain { color: var(--icon-rain); }
    .metric-icon.wind { color: var(--icon-wind); }
    .metric-icon.uv { color: var(--icon-uv); }
    .metric-icon.humidity { color: var(--icon-humidity); }
    .metric-icon.pressure { color: var(--icon-pressure); }
    .metric-icon.night { color: var(--icon-night); }
    .metric-icon.location { color: var(--icon-location); }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.7rem;
      font-weight: 600;
      background: rgba(127, 231, 255, 0.18);
      border: 1px solid rgba(127, 231, 255, 0.45);
      color: var(--accent);
      white-space: nowrap;
    }

    .badge.hidden { display: none; }

    .uv-gauge {
      position: relative;
      display: grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap: 4px;
      margin-top: 8px;
      height: 10px;
    }

    .uv-segment {
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.2);
    }

    .uv-segment.low { background: rgba(116, 211, 255, 0.6); }
    .uv-segment.moderate { background: rgba(127, 231, 255, 0.55); }
    .uv-segment.high { background: rgba(255, 211, 107, 0.6); }
    .uv-segment.very-high { background: rgba(255, 143, 107, 0.65); }
    .uv-segment.extreme { background: rgba(255, 90, 200, 0.65); }

    .uv-indicator {
      position: absolute;
      top: -5px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #fff;
      box-shadow: 0 0 8px rgba(255, 255, 255, 0.6);
      transform: translateX(-50%);
    }

    .uv-label {
      font-size: 0.8rem;
      color: var(--muted-strong);
      margin-top: 6px;
    }

    .mini-timeline {
      display: grid;
      gap: 6px;
      margin-top: 10px;
      width: 100%;
    }

    .mini-timeline-line {
      height: 1px;
      background-color: rgba(255, 255, 255, 0.18);
      border-radius: 999px;
      background-image: linear-gradient(90deg, rgba(255, 255, 255, 0.45) 1px, transparent 1px);
      background-size: calc(100% / 4) 100%;
      background-repeat: repeat-x;
    }

    .mini-timeline-labels {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      font-size: 0.8rem;
      color: var(--muted-strong);
      letter-spacing: 0.2px;
      text-align: center;
      white-space: nowrap;
      font-weight: 600;
    }

    .wind-direction {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.85rem;
      color: var(--muted-strong);
      margin-top: 4px;
    }

    .wind-arrow {
      width: 18px;
      height: 18px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transform-origin: center;
    }

    .wind-arrow svg { width: 16px; height: 16px; display: block; }

    .sparkline { width: 100%; height: 80px; }

    .sparkline path,
    .sparkline polyline {
      fill: none;
      stroke-width: 2;
    }

    .sparkline .temp { stroke: #ffd36b; }
    .sparkline .precip { stroke: #7fe7ff; }

    .footer {
      margin-top: 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      color: var(--muted);
      font-size: 0.9rem;
    }

    .signature {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .signature-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--accent-secondary);
      box-shadow: 0 0 12px rgba(180, 140, 255, 0.6);
    }

    .signature-name {
      font-weight: 600;
      letter-spacing: 0.4px;
    }

    .refresh-btn {
      border: none;
      background: rgba(127, 231, 255, 0.2);
      color: var(--accent);
      padding: 8px 18px;
      border-radius: 999px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1px solid rgba(127, 231, 255, 0.4);
    }

    .refresh-btn:hover {
      background: rgba(127, 231, 255, 0.35);
      box-shadow: 0 0 12px rgba(127, 231, 255, 0.3);
    }

    .status-card {
      display: grid;
      gap: 8px;
      text-align: center;
      color: var(--muted-strong);
    }

    .status-title {
      font-size: 1.05rem;
      font-weight: 600;
    }

    .status-details {
      font-size: 0.85rem;
      color: var(--muted);
    }

    .fade-update {
      animation: fadeUpdate 0.6s ease;
    }

    @keyframes fadeUpdate {
      0% { opacity: 0.4; }
      100% { opacity: 1; }
    }

    .skeleton {
      display: grid;
      gap: 10px;
    }

    .skeleton-line {
      height: 10px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.1);
      overflow: hidden;
      position: relative;
    }

    .skeleton-line::before,
    .skeleton-block::before {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      animation: shimmer 1.4s infinite;
    }

    .skeleton-block {
      height: 60px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.08);
      position: relative;
      overflow: hidden;
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .skeleton .w-40 { width: 40%; }
    .skeleton .w-50 { width: 50%; }
    .skeleton .w-60 { width: 60%; }
    .skeleton .w-70 { width: 70%; }
    .skeleton .w-80 { width: 80%; }

    .data-card[data-loading="true"] .card-content { display: none; }
    .data-card[data-loading="true"] .skeleton { display: grid; }
    .data-card[data-loading="false"] .skeleton { display: none; }

    .card-content {
      display: grid;
      gap: 8px;
    }

    .aqi-gauge {
      position: relative;
      height: 10px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.18);
      margin-top: 8px;
      overflow: visible;
    }

    .aqi-gauge::before {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg, rgba(116, 211, 255, 0.7), rgba(127, 231, 255, 0.7), rgba(255, 211, 107, 0.75), rgba(255, 143, 107, 0.85), rgba(255, 90, 200, 0.9));
      opacity: 0.9;
      border-radius: 999px;
    }

    .aqi-marker {
      position: absolute;
      top: -6px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #fff;
      box-shadow: 0 0 6px rgba(255, 255, 255, 0.65);
      transform: translateX(-50%);
    }

    .aqi-scale {
      display: grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap: 4px;
      font-size: 0.6rem;
      color: var(--muted);
      margin-top: 6px;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      justify-items: center;
      white-space: nowrap;
    }

    .aqi-scale span { text-align: center; }

    @media (max-width: 900px) {
      .layout { grid-template-columns: 1fr; }
      .grid { grid-template-columns: 1fr; }
      .right-col { max-width: 100%; margin-left: 0; }
      .analog { width: 210px; height: 210px; }
      .mini-forecast-row { grid-template-columns: repeat(3, minmax(0, 1fr)); }
      .sun-row { grid-template-columns: 1fr; }
      .bottom-grid { grid-template-columns: 1fr; }
      .header { flex-wrap: wrap; }
    }
  </style>
</head>

<body>
  <div class="galaxy"></div>
  <canvas id="stars"></canvas>

  <div class="container">
    <div class="header">
      <div class="title">Toulon, France</div>

      <div class="last-updated">
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <circle cx="12" cy="12" r="8" stroke="currentColor" stroke-width="1.6"/>
          <path d="M12 7v5l3 2" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        Last updated at <span id="lastUpdated">—</span>
      </div>

      <div class="unit-toggle" role="group" aria-label="Wind units">
        <button type="button" class="active" data-unit="kmh">km/h</button>
        <button type="button" data-unit="ms">m/s</button>
      </div>
    </div>

    <div class="layout">
      <div class="left-col">
        <div class="card clock-wrap">
          <div class="analog" id="analogClock"></div>
          <div class="digital">
            <div class="digital-time">
              <span id="hh">00</span><span class="blink">:</span><span id="mm">00</span>
              <span class="seconds">:<span id="ss">00</span></span>
            </div>
            <div class="digital-date" id="dateString">—</div>
          </div>
        </div>

        <div class="card weather-card data-card" id="todaySummary" data-section="weather" data-loading="true">
          <div class="skeleton">
            <span class="skeleton-line w-50"></span>
            <span class="skeleton-line w-70"></span>
          </div>
          <div class="card-content summary-content">
            <div class="weather-title">Today summary</div>
            <div class="weather-value" id="summaryTemp">—</div>
            <div class="weather-subtitle">Dew point <span id="dewPoint">—</span></div>

            <div class="summary-timeline" aria-hidden="true">
              <div class="summary-timeline-line"></div>
              <div class="summary-timeline-labels">
                <span>12AM</span>
                <span>6AM</span>
                <span>12PM</span>
                <span>6PM</span>
              </div>
            </div>
          </div>
        </div>

        <div class="card mini-forecast data-card" data-section="weather" data-loading="true">
          <div class="skeleton">
            <span class="skeleton-line w-40"></span>
            <span class="skeleton-block"></span>
          </div>
          <div class="card-content">
            <div class="weather-title">Next 6 hours</div>
            <div class="mini-forecast-row" id="miniForecast"></div>
          </div>
        </div>

        <div class="sun-row">
          <div class="card sun-card data-card" data-section="weather" data-loading="true">
            <div class="skeleton">
              <span class="skeleton-line w-60"></span>
              <span class="skeleton-block"></span>
              <span class="skeleton-line w-80"></span>
            </div>

            <div class="card-content">
              <div class="sun-card-header">
                <div class="weather-title">
                  <span class="metric-icon sun" aria-hidden="true">
                    <svg viewBox="0 0 24 24" fill="none">
                      <circle cx="12" cy="12" r="4.5" stroke="currentColor" stroke-width="1.6"/>
                      <path d="M12 2v3M12 19v3M2 12h3M19 12h3M4.5 4.5l2 2M17.5 17.5l2 2M4.5 19.5l2-2M17.5 6.5l2-2"
                            stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/>
                    </svg>
                  </span>
                  <span id="sunCardTitle">Sunrise</span>
                </div>

                <div class="sun-card-time" id="sunCardTime">—</div>
                <div class="sun-card-sub" id="sunCardSub">—</div>
              </div>

              <div class="sun-grid">
                <div class="sun-curve">
                  <svg viewBox="0 0 240 80" fill="none" aria-hidden="true">
                    <defs>
                      <linearGradient id="sunCurveGradient" x1="0" y1="0" x2="240" y2="0">
                        <stop offset="0%" stop-color="#ffd36b"/>
                        <stop offset="100%" stop-color="#7fe7ff"/>
                      </linearGradient>
                    </defs>
                    <path d="M10 70 Q120 12 230 70" stroke-width="3" class="sun-curve-track"/>
                    <path id="sunCurveProgress" d="M10 70 Q120 12 230 70" stroke-width="3" class="sun-curve-progress"/>
                    <circle id="sunCurveDot" cx="10" cy="70" r="6" class="sun-curve-dot"/>
                  </svg>
                </div>

                <div class="sun-grid-labels">
                  <span>12am</span>
                  <span>6am</span>
                  <span>12pm</span>
                  <span>6pm</span>
                </div>
              </div>
            </div>
          </div>

          <div class="card moon-card data-card" data-section="weather" data-loading="true">
            <div class="skeleton">
              <span class="skeleton-line w-60"></span>
              <span class="skeleton-block"></span>
              <span class="skeleton-line w-80"></span>
            </div>

            <div class="card-content">
              <div class="weather-title">
                <span class="metric-icon night" aria-hidden="true">
                  <svg viewBox="0 0 24 24" fill="none">
                    <path d="M15.5 3.5A8.5 8.5 0 1 0 21 17a7.5 7.5 0 0 1-5.5-13.5z"
                          stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </span>
                Moon
              </div>

              <div class="moon-visual">
                <div class="moon-icon-large" aria-hidden="true">
                  <svg viewBox="0 0 24 24" fill="none">
                    <path d="M16 4.5A8 8 0 1 0 20.5 17a7 7 0 0 1-4.5-12.5z"
                          stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </div>
                <div class="moon-phase-label" id="moonPhaseLabel">—</div>
              </div>

              <div class="moon-grid">
                <div class="moon-item"><span>Illumination</span><span id="moonIllumination">—</span></div>
                <div class="moon-item"><span>Moonrise</span><span id="moonrise">—</span></div>
                <div class="moon-item"><span>Moonset</span><span id="moonset">—</span></div>
                <div class="moon-item"><span>Next full moon</span><span id="nextFullMoon">—</span></div>
                <div class="moon-item"><span>Distance</span><span id="moonDistance">—</span></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="right-col">
        <div class="grid">
          <div class="card weather-card data-card" data-section="weather" data-loading="true">
            <div class="skeleton">
              <span class="skeleton-line w-40"></span>
              <span class="skeleton-block"></span>
            </div>
            <div class="card-content">
              <div class="weather-title">
                <span class="metric-icon location" aria-hidden="true">
                  <svg viewBox="0 0 24 24" fill="none">
                    <path d="M12 21s6-6.5 6-11a6 6 0 1 0-12 0c0 4.5 6 11 6 11z"
                          stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                    <circle cx="12" cy="10" r="2.5" stroke="currentColor" stroke-width="1.6"/>
                  </svg>
                </span>
                Conditions
              </div>

              <div class="condition-row">
                <div id="conditionIcon" class="condition-icon"></div>
                <div class="condition-text" id="conditionText">—</div>
              </div>
            </div>
          </div>

          <div class="card weather-card data-card" data-section="weather" data-loading="true">
            <div class="skeleton">
              <span class="skeleton-line w-50"></span>
              <span class="skeleton-line w-70"></span>
            </div>
            <div class="card-content">
              <div class="weather-title">
                <span class="metric-icon sun" aria-hidden="true">
                  <svg viewBox="0 0 24 24" fill="none">
                    <path d="M12 3v11" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                    <circle cx="12" cy="17" r="4" stroke="currentColor" stroke-width="1.6"/>
                    <path d="M12 14v6" stroke="currentColor" stroke-width="1.2" stroke-linecap="round"/>
                  </svg>
                </span>
                Temperature
              </div>
              <div class="weather-value" id="temp">—</div>
              <div class="weather-subtitle">Feels like <span id="feels">—</span></div>
            </div>
          </div>

          <div class="card weather-card data-card" data-section="weather" data-loading="true">
            <div class="skeleton">
              <span class="skeleton-line w-60"></span>
              <span class="skeleton-line w-70"></span>
            </div>
            <div class="card-content">
              <div class="weather-title">
                <span class="metric-icon humidity" aria-hidden="true">
                  <svg viewBox="0 0 24 24" fill="none">
                    <path d="M12 3s5 6 5 9a5 5 0 1 1-10 0c0-3 5-9 5-9z"
                          stroke="currentColor" stroke-width="1.8"
                          stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </span>
                Humidity
              </div>
              <div class="weather-value" id="humidity">—</div>
            </div>
          </div>

          <div class="card weather-card data-card" data-section="weather" data-loading="true">
            <div class="skeleton">
              <span class="skeleton-line w-50"></span>
              <span class="skeleton-line w-70"></span>
            </div>
            <div class="card-content">
              <div class="weather-title">
                <span class="metric-icon pressure" aria-hidden="true">
                  <svg viewBox="0 0 24 24" fill="none">
                    <circle cx="12" cy="12" r="8" stroke="currentColor" stroke-width="1.8"/>
                    <path d="M12 12l3-4" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                  </svg>
                </span>
                Pressure
              </div>
              <div class="weather-value" id="pressure">—</div>
            </div>
          </div>

          <div class="card weather-card data-card" data-section="weather" data-loading="true">
            <div class="skeleton">
              <span class="skeleton-line w-60"></span>
              <span class="skeleton-line w-80"></span>
              <span class="skeleton-line w-70"></span>
            </div>
            <div class="card-content">
              <div class="weather-title">
                <span class="metric-icon wind" aria-hidden="true">
                  <svg viewBox="0 0 24 24" fill="none">
                    <path d="M4 9h10a3 3 0 1 0-3-3" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                    <path d="M4 14h12a2.5 2.5 0 1 1-2.5 2.5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                  </svg>
                </span>
                Wind
              </div>

              <div class="weather-value" id="wind">—</div>
              <div class="weather-subtitle">
                Gusts <span id="gusts">—</span> <span class="badge hidden" id="gustAlert">High</span>
              </div>

              <div class="wind-direction">
                <span class="wind-arrow" id="windArrow" aria-hidden="true">
                  <svg viewBox="0 0 24 24" fill="none">
                    <path d="M12 4l4 6h-8l4-6z" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/>
                    <path d="M12 10v8" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                  </svg>
                </span>
                <span id="windDir">—</span>
              </div>

              <div class="wind-compass" aria-hidden="true">
                <span class="wind-compass-label n">N</span>
                <span class="wind-compass-label e">E</span>
                <span class="wind-compass-label s">S</span>
                <span class="wind-compass-label w">W</span>
                <div class="wind-compass-needle" id="windCompassNeedle"></div>
              </div>
            </div>
          </div>

          <div class="card weather-card data-card" data-section="weather" data-loading="true">
            <div class="skeleton">
              <span class="skeleton-line w-50"></span>
              <span class="skeleton-line w-80"></span>
            </div>
            <div class="card-content">
              <div class="weather-title">
                <span class="metric-icon uv" aria-hidden="true">
                  <svg viewBox="0 0 24 24" fill="none">
                    <circle cx="12" cy="12" r="7" stroke="currentColor" stroke-width="1.8"/>
                    <path d="M12 5v2M12 17v2M5 12h2M17 12h2" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                  </svg>
                </span>
                UV index <span class="badge hidden" id="uvAlert">High</span>
              </div>

              <div class="weather-value" id="uv">—</div>

              <div class="uv-gauge" aria-hidden="true">
                <span class="uv-segment low"></span>
                <span class="uv-segment moderate"></span>
                <span class="uv-segment high"></span>
                <span class="uv-segment very-high"></span>
                <span class="uv-segment extreme"></span>
                <span class="uv-indicator" id="uvIndicator"></span>
              </div>

              <div class="uv-label" id="uvLabel">—</div>

              <div class="mini-timeline" aria-hidden="true">
                <div class="mini-timeline-line"></div>
                <div class="mini-timeline-labels">
                  <span>12AM</span>
                  <span>6AM</span>
                  <span>12PM</span>
                  <span>6PM</span>
                </div>
              </div>
            </div>
          </div>

          <div class="card weather-card data-card" data-section="weather" data-loading="true">
            <div class="skeleton">
              <span class="skeleton-line w-50"></span>
              <span class="skeleton-line w-70"></span>
            </div>
            <div class="card-content">
              <div class="weather-title">
                <span class="metric-icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24" fill="none">
                    <path d="M2 12s4-6 10-6 10 6 10 6-4 6-10 6-10-6-10-6z"
                          stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                    <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="1.6"/>
                  </svg>
                </span>
                Visibility
              </div>
              <div class="weather-value" id="visibility">—</div>
            </div>
          </div>

          <div class="card weather-card data-card" data-section="weather" data-loading="true">
            <div class="skeleton">
              <span class="skeleton-line w-50"></span>
              <span class="skeleton-line w-70"></span>
            </div>
            <div class="card-content">
              <div class="weather-title">
                <span class="metric-icon cloud" aria-hidden="true">
                  <svg viewBox="0 0 24 24" fill="none">
                    <path d="M4 7h12a2 2 0 0 1 2 2v2H6a2 2 0 0 1-2-2V7z"
                          stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M6 13h12a2 2 0 0 1 2 2v2H8a2 2 0 0 1-2-2v-2z"
                          stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </span>
                Cloud cover
              </div>
              <div class="weather-value" id="clouds">—</div>
            </div>
          </div>

          <div class="card weather-card data-card" data-section="weather" data-loading="true">
            <div class="skeleton">
              <span class="skeleton-line w-60"></span>
              <span class="skeleton-line w-70"></span>
            </div>
            <div class="card-content">
              <div class="weather-title">
                <span class="metric-icon rain" aria-hidden="true">
                  <svg viewBox="0 0 24 24" fill="none">
                    <path d="M4 11a8 8 0 0 1 16 0" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                    <path d="M4 11h16" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                    <path d="M12 11v8" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                    <path d="M12 19c0 1.2-1 2-2.2 2" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                  </svg>
                </span>
                Precipitation probability
              </div>
              <div class="weather-value" id="precipProb">—</div>
            </div>
          </div>

          <div class="card weather-card data-card" data-section="weather" data-loading="true">
            <div class="skeleton">
              <span class="skeleton-line w-60"></span>
              <span class="skeleton-line w-70"></span>
            </div>
            <div class="card-content">
              <div class="weather-title">
                <span class="metric-icon rain" aria-hidden="true">
                  <svg viewBox="0 0 24 24" fill="none">
                    <path d="M6 12h10a4 4 0 0 0 0-8 6 6 0 0 0-11.2 1.8A3.5 3.5 0 0 0 6 12z"
                          stroke="currentColor" stroke-width="1.8"
                          stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M9 16l-1 3M13 16l-1 3M17 16l-1 3"
                          stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                  </svg>
                </span>
                Rain rate
              </div>
              <div class="weather-value" id="rainRate">—</div>
              <div class="weather-subtitle">Max rain chance <span id="summaryRain">—</span></div>
            </div>
          </div>
        </div>

        <div class="bottom-grid">
          <div class="card weather-card data-card" data-section="air" data-loading="true">
            <div class="skeleton">
              <span class="skeleton-line w-60"></span>
              <span class="skeleton-line w-80"></span>
            </div>
            <div class="card-content">
              <div class="weather-title">
                <span class="metric-icon wind" aria-hidden="true">
                  <svg viewBox="0 0 24 24" fill="none">
                    <path d="M4 11h12a3 3 0 1 0-3-3" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                    <path d="M4 15h10a2.5 2.5 0 1 1-2.5 2.5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                  </svg>
                </span>
                Air quality <span class="badge hidden" id="aqiAlert">Poor</span>
              </div>

              <div class="weather-value" id="airQuality">—</div>

              <div class="aqi-gauge" aria-hidden="true">
                <span class="aqi-marker" id="aqiMarker" style="left: 0%;"></span>
              </div>

              <div class="aqi-scale" aria-hidden="true">
                <span>Good</span>
                <span>Fair</span>
                <span>Moderate</span>
                <span>Poor</span>
                <span>Severe</span>
              </div>
            </div>
          </div>

          <div class="card weather-card data-card" data-section="weather" data-loading="true">
            <div class="skeleton">
              <span class="skeleton-line w-60"></span>
              <span class="skeleton-block"></span>
            </div>
            <div class="card-content">
              <div class="weather-title">
                <span class="metric-icon sun" aria-hidden="true">
                  <svg viewBox="0 0 24 24" fill="none">
                    <path d="M5 12h14" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                    <path d="M12 5v14" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/>
                  </svg>
                </span>
                24h outlook
              </div>

              <svg class="sparkline" viewBox="0 0 300 80">
                <polyline id="tempLine" class="temp" points=""></polyline>
                <polyline id="precipLine" class="precip" points=""></polyline>
              </svg>

              <div class="weather-subtitle">Mini temp curve + precip probability</div>
            </div>
          </div>
        </div>

        <div class="card" id="statusCard" style="display:none;">
          <div class="status-card">
            <div class="status-title">Weather temporarily unavailable</div>
            <div class="status-details" id="statusDetails"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="footer">
      <div class="signature">
        <span class="signature-dot" aria-hidden="true"></span>
        <span class="signature-name">B. Geeverding</span>
      </div>
      <button class="refresh-btn" id="refreshBtn">Refresh</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/suncalc@1.9.0/suncalc.min.js"></script>

  <script>
    let CITY = "Toulon";
    let COUNTRY = "France";
    let LAT = 43.12442;
    let LON = 5.92836;
    let TZ = "Europe/Paris";
    const REFRESH_MS = 10 * 60 * 1000;
    const UNIT_KEY = "horloge:wind-unit";

    const state = {
      weather: null,
      air: null,
      units: { wind: "kmh" }
    };

    const $ = (id) => document.getElementById(id);

    function formatValue(value, formatter, fallback = "—") {
      if (!Number.isFinite(value)) return fallback;
      return formatter(value);
    }

    function triggerFade(el) {
      if (!el) return;
      el.classList.remove("fade-update");
      void el.offsetWidth;
      el.classList.add("fade-update");
    }

    function setText(id, value) {
      const el = $(id);
      if (!el) return;
      if (el.textContent === value) return;
      el.textContent = value;
      triggerFade(el);
    }

    function setHtml(id, value) {
      const el = $(id);
      if (!el) return;
      if (el.innerHTML === value) return;
      el.innerHTML = value;
      triggerFade(el);
    }

    function setSectionLoading(section, isLoading) {
      document.querySelectorAll(`.data-card[data-section="${section}"]`).forEach((card) => {
        card.dataset.loading = isLoading ? "true" : "false";
      });
    }

    function triggerSectionFade(section) {
      document.querySelectorAll(`.data-card[data-section="${section}"]`).forEach((card) => {
        card.classList.remove("fade-update");
        void card.offsetWidth;
        card.classList.add("fade-update");
      });
    }

    function formatWindSpeed(value) {
      if (!Number.isFinite(value)) return "—";
      if (state.units.wind === "ms") {
        const ms = value / 3.6;
        return `${Math.round(ms)} m/s`;
      }
      return `${Math.round(value)} km/h`;
    }

    function formatRainRate(value) {
      if (!Number.isFinite(value)) return "—";
      if (value <= 0) return "0 mm/h";
      if (value < 10) return `${value.toFixed(1)} mm/h`;
      return `${Math.round(value)} mm/h`;
    }

    function applyWindUnit(unit) {
      state.units.wind = unit;
      try { localStorage.setItem(UNIT_KEY, unit); } catch (e) { return; }
    }

    function updateUnitToggle() {
      document.querySelectorAll(".unit-toggle button").forEach((btn) => {
        btn.classList.toggle("active", btn.dataset.unit === state.units.wind);
      });
    }

    function initUnitToggle() {
      try {
        const stored = localStorage.getItem(UNIT_KEY);
        if (stored === "kmh" || stored === "ms") state.units.wind = stored;
      } catch (e) {}

      updateUnitToggle();
      document.querySelectorAll(".unit-toggle button").forEach((btn) => {
        btn.addEventListener("click", () => {
          applyWindUnit(btn.dataset.unit);
          updateUnitToggle();
          if (state.weather) renderWeather(state.weather);
        });
      });
    }

    function buildClockFace() {
      const clock = $("analogClock");
      if (!clock) return;
      clock.innerHTML = "";

      const fragment = document.createDocumentFragment();
      for (let i = 0; i < 60; i += 1) {
        const tick = document.createElement("div");
        tick.className = `tick${i % 5 === 0 ? " major" : ""}`;
        tick.style.transform = `translateX(-50%) rotate(${i * 6}deg)`;
        fragment.appendChild(tick);
      }

      const size = clock.clientWidth || 230;
      const center = size / 2;
      const radius = center - 36;

      const numbers = [
        { label: "12", angle: 0,  dx: 0,  dy: 10 },
        { label: "3",  angle: 90, dx: -6, dy: 0  },
        { label: "6",  angle: 180,dx: 0,  dy: -2 },
        { label: "9",  angle: 270,dx: 6,  dy: 0  }
      ];

      numbers.forEach(({ label, angle, dx, dy }) => {
        const number = document.createElement("div");
        number.className = "clock-number";
        const theta = (angle - 90) * (Math.PI / 180);
        number.style.left = `${center + Math.cos(theta) * radius + dx}px`;
        number.style.top = `${center + Math.sin(theta) * radius + dy}px`;
        number.textContent = label;
        fragment.appendChild(number);
      });

      const hourHand = document.createElement("div");
      hourHand.className = "hand hour";
      hourHand.id = "hourHand";
      fragment.appendChild(hourHand);

      const minuteHand = document.createElement("div");
      minuteHand.className = "hand minute";
      minuteHand.id = "minuteHand";
      fragment.appendChild(minuteHand);

      const secondHand = document.createElement("div");
      secondHand.className = "hand second";
      secondHand.id = "secondHand";
      fragment.appendChild(secondHand);

      const centerDot = document.createElement("div");
      centerDot.className = "center-dot";
      fragment.appendChild(centerDot);

      clock.appendChild(fragment);
    }

    function updateClock() {
      const now = new Date();
      const timeParts = new Intl.DateTimeFormat("en-GB", {
        timeZone: TZ,
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit",
        hour12: false
      }).formatToParts(now).reduce((acc, part) => {
        acc[part.type] = part.value;
        return acc;
      }, {});

      const hour = Number(timeParts.hour);
      const minute = Number(timeParts.minute);
      const second = Number(timeParts.second);

      setText("hh", String(timeParts.hour).padStart(2, "0"));
      setText("mm", String(timeParts.minute).padStart(2, "0"));
      setText("ss", String(timeParts.second).padStart(2, "0"));

      const dateParts = new Intl.DateTimeFormat("en-GB", {
        timeZone: TZ,
        weekday: "long",
        day: "2-digit",
        month: "short",
        year: "numeric"
      }).formatToParts(now).reduce((acc, part) => {
        acc[part.type] = part.value;
        return acc;
      }, {});

      if (dateParts.weekday && dateParts.day && dateParts.month && dateParts.year) {
        setText("dateString", `${dateParts.weekday}, ${dateParts.day} ${dateParts.month} ${dateParts.year}`);
      }

      const hourHand = $("hourHand");
      const minuteHand = $("minuteHand");
      const secondHand = $("secondHand");

      if (hourHand) {
        const hourAngle = ((hour % 12) + minute / 60) * 30;
        hourHand.style.transform = `rotate(${hourAngle}deg)`;
      }
      if (minuteHand) {
        const minuteAngle = (minute + second / 60) * 6;
        minuteHand.style.transform = `rotate(${minuteAngle}deg)`;
      }
      if (secondHand) {
        const secondAngle = second * 6;
        secondHand.style.transform = `rotate(${secondAngle}deg)`;
      }
    }

    function formatHourMinute(hour, minute) {
      if (hour == null || minute == null) return "—";
      const safeHour = String(Number(hour));
      const safeMinute = String(minute).padStart(2, "0");
      return `${safeHour}h${safeMinute}`;
    }

    function getTimePartsFromDate(date) {
      if (!(date instanceof Date) || Number.isNaN(date.getTime())) return null;
      const formatter = new Intl.DateTimeFormat("en-GB", {
        timeZone: TZ,
        hour: "2-digit",
        minute: "2-digit",
        hour12: false
      });
      const parts = formatter.formatToParts(date).reduce((acc, part) => {
        acc[part.type] = part.value;
        return acc;
      }, {});
      return { hour: parts.hour, minute: parts.minute };
    }

    function splitLocalTime(timeValue) {
      if (!timeValue) return null;
      if (timeValue instanceof Date) return getTimePartsFromDate(timeValue);
      const [, timePart] = String(timeValue).split("T");
      if (!timePart) return null;
      const [hour, minute] = timePart.split(":");
      return { hour, minute };
    }

    function formatTimeHMFromParts(parts) {
      if (!parts?.hour || !parts?.minute) return "—";
      return formatHourMinute(parts.hour, parts.minute);
    }

    function formatTimeHMFromDate(date) {
      const parts = getTimePartsFromDate(date);
      if (!parts) return "—";
      return formatHourMinute(parts.hour, parts.minute);
    }

    function getZonedDate(date, timeZone) {
      const formatter = new Intl.DateTimeFormat("en-GB", {
        timeZone,
        year: "numeric",
        month: "2-digit",
        day: "2-digit"
      });
      const parts = formatter.formatToParts(date).reduce((acc, part) => {
        acc[part.type] = part.value;
        return acc;
      }, {});
      return new Date(Date.UTC(
        Number(parts.year),
        Number(parts.month) - 1,
        Number(parts.day),
        12, 0, 0
      ));
    }

    function formatHourAmPmHtml(hourValue) {
      if (!Number.isFinite(hourValue)) return "—";
      const hour12 = hourValue % 12 || 12;
      const suffix = hourValue >= 12 ? "PM" : "AM";
      return `${hour12}<span class="ampm">${suffix}</span>`;
    }

    function updateLastUpdated() {
      const now = new Date();
      const parts = getTimePartsFromDate(now);
      setText("lastUpdated", formatTimeHMFromParts(parts));
    }

    function updateLocationDisplay() {
      const isFallback = !CITY || CITY === "Near you";
      const safeCity = isFallback ? "Toulon" : CITY;
      const safeCountry = isFallback ? "France" : (COUNTRY || "");
      const label = safeCountry ? `${safeCity}, ${safeCountry}` : safeCity;
      document.querySelector(".title").textContent = label;
      document.title = `${safeCity} — Clock & Weather`;
    }

    function initLocation() {
      TZ = "Europe/Paris";
      CITY = "Toulon";
      COUNTRY = "France";
      LAT = 43.12442;
      LON = 5.92836;
      updateLocationDisplay();
    }

    function weatherLabel(code) {
      const map = {
        0: "Clear",
        1: "Mainly clear",
        2: "Partly cloudy",
        3: "Overcast",
        45: "Fog",
        48: "Rime fog",
        51: "Light drizzle",
        53: "Drizzle",
        55: "Heavy drizzle",
        56: "Freezing drizzle",
        57: "Heavy freezing drizzle",
        61: "Light rain",
        63: "Rain",
        65: "Heavy rain",
        66: "Freezing rain",
        67: "Heavy freezing rain",
        71: "Light snow",
        73: "Snow",
        75: "Heavy snow",
        77: "Snow grains",
        80: "Rain showers",
        81: "Heavy showers",
        82: "Violent showers",
        85: "Snow showers",
        86: "Heavy snow showers",
        95: "Thunderstorm",
        96: "Thunderstorm hail",
        99: "Severe thunderstorm hail"
      };
      return map[code] || "Conditions";
    }

    function moonPhaseName(date) {
      const phase = SunCalc.getMoonIllumination(date).phase;
      if (phase < 0.03 || phase > 0.97) return "New Moon";
      if (phase < 0.22) return "Waxing Crescent";
      if (phase < 0.28) return "First Quarter";
      if (phase < 0.47) return "Waxing Gibbous";
      if (phase < 0.53) return "Full Moon";
      if (phase < 0.72) return "Waning Gibbous";
      if (phase < 0.78) return "Last Quarter";
      return "Waning Crescent";
    }

    function loadWeather() {
      const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}&timezone=${TZ}&current=temperature_2m,relative_humidity_2m,apparent_temperature,precipitation,precipitation_probability,weather_code,pressure_msl,cloud_cover,wind_speed_10m,wind_gusts_10m,wind_direction_10m,visibility,dew_point_2m,uv_index,is_day,rain&hourly=temperature_2m,precipitation_probability,precipitation,weather_code&daily=sunrise,sunset&forecast_days=2`;
      setSectionLoading("weather", true);

      fetch(weatherUrl)
        .then((res) => res.ok ? res.json() : Promise.reject(res))
        .then((data) => {
          state.weather = normalizeWeather(data);
          renderWeather(state.weather);
          updateLastUpdated();
          setSectionLoading("weather", false);
          triggerSectionFade("weather");
        })
        .catch((err) => {
          console.error("Weather fetch failed", err);
          if (!state.weather) {
            state.weather = buildDemoWeather();
            renderWeather(state.weather);
          }
          setSectionLoading("weather", false);
          triggerSectionFade("weather");
        });
    }

    function loadAirQuality() {
      const airUrl = `https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${LAT}&longitude=${LON}&timezone=${TZ}&current=us_aqi`;
      setSectionLoading("air", true);

      fetch(airUrl)
        .then((res) => res.ok ? res.json() : Promise.reject(res))
        .then((data) => {
          state.air = data;
          renderAirQuality(state.air);
          setSectionLoading("air", false);
          triggerSectionFade("air");
        })
        .catch((err) => {
          console.error("Air quality fetch failed", err);
          if (!state.air) state.air = buildDemoAirQuality();
          renderAirQuality(state.air);
          setSectionLoading("air", false);
          triggerSectionFade("air");
        });
    }

    function normalizeWeather(data) {
      if (!data || !data.current) return buildDemoWeather();

      const current = { ...data.current };
      current.time = new Date(current.time);

      const hourly = { ...data.hourly };
      hourly.time = (hourly.time || []).map((t) => new Date(t));

      const daily = { ...data.daily };
      daily.sunrise = (daily.sunrise || []).map((t) => new Date(t));
      daily.sunset = (daily.sunset || []).map((t) => new Date(t));

      return { current, hourly, daily };
    }

    function weatherIcon(code) {
      const cloud = "#c7d1e2";
      const rain = "#86dcff";
      const sun = "#ffd36b";
      const night = "#bda8ff";

      if (code === 0) {
        return `<svg width="40" height="40" viewBox="0 0 64 64" fill="none" stroke="${sun}" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="32" cy="32" r="10" />
          <path d="M32 8v6M32 50v6M8 32h6M50 32h6M14.5 14.5l4 4M45.5 45.5l4 4M14.5 49.5l4-4M45.5 18.5l4-4" />
        </svg>`;
      }

      if (code === 1 || code === 2) {
        return `<svg width="40" height="40" viewBox="0 0 64 64" fill="none" stroke="${cloud}" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M20 40h26a10 10 0 0 0 0-20 16 16 0 0 0-31.1 4A8 8 0 0 0 20 40z" />
        </svg>`;
      }

      if (code === 3) {
        return `<svg width="40" height="40" viewBox="0 0 64 64" fill="none" stroke="${cloud}" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M18 40h30a12 12 0 0 0 0-24 18 18 0 0 0-35 5A9 9 0 0 0 18 40z" />
          <path d="M20 45h26" />
        </svg>`;
      }

      if (code >= 45 && code <= 48) {
        return `<svg width="40" height="40" viewBox="0 0 64 64" fill="none" stroke="${cloud}" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M18 40h30a12 12 0 0 0 0-24 18 18 0 0 0-35 5A9 9 0 0 0 18 40z" />
          <path d="M24 48h16" stroke="${rain}" />
          <path d="M20 52h24" stroke="${rain}" />
        </svg>`;
      }

      if ((code >= 51 && code <= 57) || (code >= 61 && code <= 67)) {
        return `<svg width="40" height="40" viewBox="0 0 64 64" fill="none" stroke="${cloud}" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M18 36h30a12 12 0 0 0 0-24 18 18 0 0 0-35 5A9 9 0 0 0 18 36z" />
          <path d="M22 44l-4 8M32 44l-4 8M42 44l-4 8" stroke="${rain}" />
        </svg>`;
      }

      if ((code >= 71 && code <= 77) || (code >= 85 && code <= 86)) {
        return `<svg width="40" height="40" viewBox="0 0 64 64" fill="none" stroke="${cloud}" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M20 36h26a10 10 0 0 0 0-20 16 16 0 0 0-31.1 4A8 8 0 0 0 20 36z" />
          <path d="M24 44l4 6M32 44l4 6M40 44l4 6" stroke="${rain}" />
        </svg>`;
      }

      if (code >= 95) {
        return `<svg width="40" height="40" viewBox="0 0 64 64" fill="none" stroke="${cloud}" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M20 36h26a10 10 0 0 0 0-20 16 16 0 0 0-31.1 4A8 8 0 0 0 20 36z" />
          <path d="M20 48l4-6M32 48l-3-6M44 48l-4-6" stroke="${sun}" />
        </svg>`;
      }

      return `<svg width="40" height="40" viewBox="0 0 64 64" fill="none" stroke="${night}" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M36 10a18 18 0 1 0 18 18 14 14 0 0 1-18-18z" />
      </svg>`;
    }

    function buildDemoWeather() {
      const now = new Date();
      const dayStart = getZonedDate(now, TZ);
      const sunTimes = SunCalc.getTimes(dayStart, LAT, LON);
      const tomorrow = new Date(dayStart.valueOf() + 24 * 60 * 60 * 1000);
      const sunTimesTomorrow = SunCalc.getTimes(tomorrow, LAT, LON);

      const hourlyTimes = [];
      const hourlyTemps = [];
      const hourlyProbs = [];
      const hourlyCodes = [];
      const hourlyPrecip = [];

      const baseTemp = 23;
      for (let i = 0; i < 24; i++) {
        const hourDate = new Date(now.valueOf() + i * 60 * 60 * 1000);
        hourlyTimes.push(hourDate);
        const temp = baseTemp + Math.sin((i / 24) * Math.PI * 2) * 4;
        hourlyTemps.push(temp);
        const prob = Math.max(0, 20 + Math.sin((i / 24) * Math.PI * 2 + 1.4) * 25);
        hourlyProbs.push(prob);
        hourlyCodes.push(prob > 60 ? 63 : prob > 35 ? 2 : 1);
        hourlyPrecip.push(prob > 60 ? 1.2 : prob > 35 ? 0.3 : 0);
      }

      return {
        current: {
          temperature_2m: 24.3,
          apparent_temperature: 25.1,
          relative_humidity_2m: 62,
          dew_point_2m: 16.4,
          pressure_msl: 1015,
          wind_speed_10m: 18,
          wind_gusts_10m: 28,
          wind_direction_10m: 225,
          cloud_cover: 32,
          visibility: 9000,
          precipitation: 0.2,
          precipitation_probability: 35,
          weather_code: 2,
          uv_index: 6,
          is_day: 1,
          rain: 0,
          time: now
        },
        hourly: {
          time: hourlyTimes,
          temperature_2m: hourlyTemps,
          precipitation_probability: hourlyProbs,
          precipitation: hourlyPrecip,
          weather_code: hourlyCodes
        },
        daily: {
          sunrise: [sunTimes.sunrise, sunTimesTomorrow.sunrise],
          sunset: [sunTimes.sunset, sunTimesTomorrow.sunset]
        }
      };
    }

    function buildDemoAirQuality() {
      return { current: { us_aqi: 42 } };
    }

    function renderAirQuality(data) {
      const aqi = data?.current?.us_aqi;
      if (aqi == null) {
        setText("airQuality", "—");
        updateAqiGauge(null);
        return;
      }

      setText("airQuality", `${aqi} AQI`);
      updateAqiGauge(aqi);

      if (state.weather?.current) updateAlerts(state.weather.current);
    }

    function renderWeather(data) {
      const c = data.current;
      if (!c) return;

      setText("temp", formatValue(c.temperature_2m, (v) => `${Math.round(v)}°C`));
      setText("feels", formatValue(c.apparent_temperature, (v) => `${Math.round(v)}°C`));
      setText("humidity", formatValue(c.relative_humidity_2m, (v) => `${Math.round(v)}%`));
      setText("dewPoint", formatValue(c.dew_point_2m, (v) => `${Math.round(v)}°C`));
      setText("pressure", formatValue(c.pressure_msl, (v) => `${Math.round(v)} hPa`));
      setText("wind", formatWindSpeed(c.wind_speed_10m));
      setText("gusts", formatWindSpeed(c.wind_gusts_10m));
      setText("uv", formatValue(c.uv_index, (v) => `${Math.round(v)}`));
      setText("visibility", formatValue(c.visibility, (v) => `${(v / 1000).toFixed(1)} km`));
      setText("clouds", formatValue(c.cloud_cover, (v) => `${Math.round(v)}%`));
      setText("precipProb", formatValue(c.precipitation_probability, (v) => `${Math.round(v)}%`));

      const rainRateRaw = c.rain ?? c.precipitation;
      const rainRate = Number.isFinite(rainRateRaw) ? rainRateRaw : 0;
      setText("rainRate", formatRainRate(rainRate));

      const code = Number.isFinite(c.weather_code) ? c.weather_code : null;
      setText("conditionText", code != null ? weatherLabel(code) : "—");
      setHtml("conditionIcon", weatherIcon(code ?? -1));

      const windDir = Number.isFinite(c.wind_direction_10m) ? c.wind_direction_10m : null;
      updateWindDirection(windDir);
      updateAlerts(c);

      renderSparkline(data);
      renderMiniForecast(data);
      renderTodaySummary(data);
      renderSunCard(data);
      renderMoonCard(data);
      updateUvGauge(c.uv_index);
    }

    function renderSparkline(data) {
      const temps = data.hourly?.temperature_2m?.slice(0, 24) || [];
      const probs = data.hourly?.precipitation_probability?.slice(0, 24) || [];
      if (!temps.length) return;

      const tempMin = Math.min(...temps);
      const tempMax = Math.max(...temps);
      const width = 300;
      const height = 80;

      const tempPoints = temps.map((t, i) => {
        const x = (i / (temps.length - 1)) * width;
        const y = height - ((t - tempMin) / (tempMax - tempMin || 1)) * (height - 10) - 5;
        return `${x},${y}`;
      }).join(" ");

      const probPoints = probs.map((p, i) => {
        const x = (i / (probs.length - 1)) * width;
        const y = height - (p / 100) * (height - 10) - 5;
        return `${x},${y}`;
      }).join(" ");

      $("tempLine").setAttribute("points", tempPoints);
      $("precipLine").setAttribute("points", probPoints);
    }

    function renderMiniForecast(data) {
      const container = $("miniForecast");
      container.innerHTML = "";

      const times = data.hourly?.time || [];
      const temps = data.hourly?.temperature_2m || [];
      const probs = data.hourly?.precipitation_probability || [];
      const codes = data.hourly?.weather_code || [];

      const sunrise = data.daily?.sunrise?.[0] || null;
      const currentTime = data.current?.time;
      const current = data.current || {};

      if (!times.length) return;

      const nowDate = currentTime instanceof Date ? currentTime : new Date();
      const nextIndices = [];
      for (let i = 0; i < times.length; i++) {
        const timeDate = times[i] instanceof Date ? times[i] : new Date(times[i]);
        if (Number.isNaN(timeDate.getTime())) continue;
        if (timeDate > nowDate) nextIndices.push(i);
        if (nextIndices.length === 5) break;
      }

      const nowItem = document.createElement("div");
      nowItem.className = "mini-item";

      const nowTemp = Number.isFinite(current.temperature_2m) ? `${Math.round(current.temperature_2m)}°` : "—";
      const nowProb = Number.isFinite(current.precipitation_probability) ? `${Math.round(current.precipitation_probability)}%` : "—";
      const nowCode = Number.isFinite(current.weather_code) ? current.weather_code : -1;

      nowItem.innerHTML = `
        <div class="mini-time">Now</div>
        <div class="mini-icon">${weatherIcon(nowCode)}</div>
        <div class="mini-temp">${nowTemp}</div>
        <div class="mini-precip">${nowProb}</div>
      `;
      container.appendChild(nowItem);

      nextIndices.forEach((idx) => {
        const time = times[idx];
        const timeParts = splitLocalTime(time);
        const hourValue = timeParts ? Number(timeParts.hour) : NaN;
        const label = formatHourAmPmHtml(hourValue);

        const temp = temps[idx];
        const prob = probs[idx];
        const code = codes[idx];
        const tempLabel = Number.isFinite(temp) ? `${Math.round(temp)}°` : "—";
        const probLabel = Number.isFinite(prob) ? `${Math.round(prob)}%` : "—";

        const item = document.createElement("div");
        item.className = "mini-item";
        item.innerHTML = `
          <div class="mini-time">${label}</div>
          <div class="mini-icon">${weatherIcon(code)}</div>
          <div class="mini-temp">${tempLabel}</div>
          <div class="mini-precip">${probLabel}</div>
        `;

        if (sunrise) {
          const sunriseParts = splitLocalTime(sunrise);
          if (sunriseParts && timeParts && sunriseParts.hour === timeParts.hour) {
            const marker = document.createElement("div");
            marker.className = "mini-marker";
            marker.textContent = "Sunrise";
            item.appendChild(marker);
          }
        }

        container.appendChild(item);
      });
    }

    function renderTodaySummary(data) {
      const times = data.hourly?.time || [];
      const temps = data.hourly?.temperature_2m || [];
      const probs = data.hourly?.precipitation_probability || [];
      const currentTime = data.current?.time;
      const nowDate = currentTime instanceof Date ? currentTime : new Date();

      const startIndex = times.findIndex((t) => {
        const timeDate = t instanceof Date ? t : new Date(t);
        return timeDate >= nowDate;
      });

      const index = startIndex >= 0 ? startIndex : 0;
      const endIndex = Math.min(index + 24, temps.length);

      if (!temps.length || endIndex <= index) {
        setText("summaryTemp", "—");
        setText("summaryRain", "—");
        return;
      }

      const tempSlice = temps.slice(index, endIndex).filter((v) => Number.isFinite(v));
      const probSlice = probs.slice(index, endIndex).filter((v) => Number.isFinite(v));

      const minTemp = tempSlice.length ? Math.min(...tempSlice) : null;
      const maxTemp = tempSlice.length ? Math.max(...tempSlice) : null;
      const maxProb = probSlice.length ? Math.max(...probSlice) : null;

      const tempLabel = minTemp == null || maxTemp == null ? "—" : `${Math.round(minTemp)}° / ${Math.round(maxTemp)}°`;
      const probLabel = maxProb == null ? "—" : `${Math.round(maxProb)}%`;

      setText("summaryTemp", tempLabel);
      setText("summaryRain", probLabel);
    }

    function formatDurationMinutes(minutes) {
      if (!Number.isFinite(minutes)) return "—";
      const total = Math.max(0, Math.round(minutes));
      const hrs = Math.floor(total / 60);
      const mins = total % 60;
      if (hrs === 0) return `${mins} m`;
      return `${hrs} h ${mins} m`;
    }

    function renderSunCard(data) {
      const sunrise = data.daily?.sunrise?.[0];
      const sunset = data.daily?.sunset?.[0];
      const sunriseTomorrow = data.daily?.sunrise?.[1];
      const now = data.current?.time instanceof Date ? data.current.time : new Date();

      const curve = $("sunCurveProgress");
      const dot = $("sunCurveDot");

      if (!(sunrise instanceof Date) || !(sunset instanceof Date)) {
        setText("sunCardTitle", "—");
        setText("sunCardTime", "—");
        setText("sunCardSub", "—");
        if (curve) {
          const length = curve.getTotalLength();
          curve.style.strokeDasharray = length;
          curve.style.strokeDashoffset = length;
        }
        if (dot) {
          dot.setAttribute("cx", "10");
          dot.setAttribute("cy", "70");
        }
        return;
      }

      if (now < sunrise) {
        setText("sunCardTitle", "Sunrise");
        setText("sunCardTime", formatTimeHMFromDate(sunrise));
        const minutes = (sunrise - now) / 60000;
        setText("sunCardSub", `Sunrise in ${formatDurationMinutes(minutes)}`);
      } else if (now >= sunrise && now <= sunset) {
        setText("sunCardTitle", "Sunset");
        setText("sunCardTime", formatTimeHMFromDate(sunset));
        const minutes = (sunset - now) / 60000;
        setText("sunCardSub", `Daylight remaining ${formatDurationMinutes(minutes)}`);
      } else {
        setText("sunCardTitle", "Sunrise");
        if (sunriseTomorrow instanceof Date) {
          setText("sunCardTime", formatTimeHMFromDate(sunriseTomorrow));
          const minutes = (sunriseTomorrow - now) / 60000;
          setText("sunCardSub", `Daylight begins in ${formatDurationMinutes(minutes)}`);
        } else {
          setText("sunCardTime", "—");
          setText("sunCardSub", "Daylight begins in —");
        }
      }

      const total = sunset - sunrise;
      const elapsed = now - sunrise;
      const progress = total > 0 ? Math.min(Math.max(elapsed / total, 0), 1) : 0;

      if (curve) {
        const length = curve.getTotalLength();
        curve.style.strokeDasharray = length;
        curve.style.strokeDashoffset = length - length * progress;
      }

      if (dot) {
        const startX = 10;
        const endX = 230;
        const baseY = 70;
        const peakY = 12;
        const x = startX + (endX - startX) * progress;
        const y = baseY - Math.sin(progress * Math.PI) * (baseY - peakY);
        dot.setAttribute("cx", x.toFixed(1));
        dot.setAttribute("cy", y.toFixed(1));
      }
    }

    function formatDateDayMonth(date) {
      if (!(date instanceof Date) || Number.isNaN(date.getTime())) return "—";
      return new Intl.DateTimeFormat("en-GB", {
        timeZone: TZ,
        day: "2-digit",
        month: "short"
      }).format(date);
    }

    function renderMoonCard(data) {
      const now = data.current?.time instanceof Date ? data.current.time : new Date();

      const illumination = SunCalc.getMoonIllumination(now);
      const illuminationPct = Math.round(illumination.fraction * 100);
      setText("moonIllumination", `${illuminationPct} %`);

      const moonTimes = SunCalc.getMoonTimes(getZonedDate(now, TZ), LAT, LON, true);
      const riseLabel = moonTimes?.rise ? formatTimeHMFromDate(moonTimes.rise) : "—";
      const setLabel = moonTimes?.set ? formatTimeHMFromDate(moonTimes.set) : "—";
      setText("moonrise", riseLabel);
      setText("moonset", setLabel);

      const moonPosition = SunCalc.getMoonPosition(now, LAT, LON);
      const distanceLabel = Number.isFinite(moonPosition.distance)
        ? `${Math.round(moonPosition.distance)} km`
        : "—";
      setText("moonDistance", distanceLabel);

      setText("moonPhaseLabel", moonPhaseName(now));

      let bestDate = null;
      let bestDelta = Infinity;
      for (let i = 0; i <= 30; i++) {
        const date = new Date(now.valueOf() + i * 24 * 60 * 60 * 1000);
        const phase = SunCalc.getMoonIllumination(getZonedDate(date, TZ)).phase;
        const delta = Math.abs(phase - 0.5);
        if (delta < bestDelta) {
          bestDelta = delta;
          bestDate = date;
        }
      }
      setText("nextFullMoon", bestDate ? formatDateDayMonth(bestDate) : "—");
    }

    function updateUvGauge(value) {
      const indicator = $("uvIndicator");
      const label = $("uvLabel");
      if (!indicator || !label) return;

      if (!Number.isFinite(value)) {
        indicator.style.display = "none";
        setText("uvLabel", "—");
        return;
      }

      indicator.style.display = "block";
      const capped = Math.max(0, Math.min(11, value));
      const percent = (capped / 11) * 100;
      indicator.style.left = `${percent}%`;

      let level = "Low";
      if (value >= 11) level = "Extreme";
      else if (value >= 8) level = "Very High";
      else if (value >= 6) level = "High";
      else if (value >= 3) level = "Moderate";

      setText("uvLabel", `${level} exposure`);
    }

    function updateAqiGauge(value) {
      const marker = $("aqiMarker");
      if (!marker) return;
      if (!Number.isFinite(value)) {
        marker.style.display = "none";
        return;
      }
      marker.style.display = "block";
      const capped = Math.max(0, Math.min(300, value));
      const percent = (capped / 300) * 100;
      marker.style.left = `${percent}%`;
    }

    function updateAlerts(current) {
      const uvAlert = $("uvAlert");
      const gustAlert = $("gustAlert");
      const aqiAlert = $("aqiAlert");

      const uvValue = Number(current.uv_index);
      const gustValue = Number(current.wind_gusts_10m);

      uvAlert.classList.toggle("hidden", !(uvValue > 6));
      gustAlert.classList.toggle("hidden", !(gustValue > 40));

      if (state.air?.current?.us_aqi != null) {
        aqiAlert.classList.toggle("hidden", !(Number(state.air.current.us_aqi) > 100));
      } else {
        aqiAlert.classList.add("hidden");
      }
    }

    function degToCompass(deg) {
      if (!Number.isFinite(deg)) return "—";
      const directions = ["N", "NE", "E", "SE", "S", "SW", "W", "NW"];
      const index = Math.round(((deg % 360) / 45)) % 8;
      return directions[index];
    }

    function updateWindDirection(deg) {
      const arrow = $("windArrow");
      const compassNeedle = $("windCompassNeedle");
      if (!Number.isFinite(deg)) {
        setText("windDir", "—");
        if (arrow) arrow.style.transform = "rotate(0deg)";
        if (compassNeedle) compassNeedle.style.transform = "rotate(0deg)";
        return;
      }
      if (arrow) arrow.style.transform = `rotate(${deg}deg)`;
      if (compassNeedle) compassNeedle.style.transform = `rotate(${deg}deg)`;
      setText("windDir", `${degToCompass(deg)} • ${Math.round(deg)}°`);
    }

    function initStars() {
      const canvas = $("stars");
      const ctx = canvas.getContext("2d");

      let w, h;
      const starColors = ["255,255,255", "180,210,255", "255,200,230", "255,180,200"];
      const stars = Array.from({ length: 260 }, () => ({
        x: Math.random(),
        y: Math.random(),
        r: Math.random() * 1.4 + 0.2,
        alpha: Math.random() * 0.5 + 0.18,
        drift: (Math.random() - 0.5) * 0.00018,
        color: starColors[Math.floor(Math.random() * starColors.length)]
      }));

      function resize() {
        w = canvas.width = window.innerWidth;
        h = canvas.height = window.innerHeight;
      }

      window.addEventListener("resize", resize);
      resize();

      function draw() {
        ctx.clearRect(0, 0, w, h);
        for (const s of stars) {
          s.y += s.drift;
          if (s.y < 0) s.y = 1;
          if (s.y > 1) s.y = 0;

          ctx.beginPath();
          ctx.fillStyle = `rgba(${s.color},${s.alpha})`;
          ctx.arc(s.x * w, s.y * h, s.r, 0, Math.PI * 2);
          ctx.fill();
        }
        requestAnimationFrame(draw);
      }

      draw();
    }

    function init() {
      initLocation();
      buildClockFace();
      updateClock();
      setInterval(updateClock, 1000);
      initUnitToggle();

      loadWeather();
      loadAirQuality();
      setInterval(loadWeather, REFRESH_MS);
      setInterval(loadAirQuality, REFRESH_MS);

      $("refreshBtn").addEventListener("click", () => {
        loadWeather();
        loadAirQuality();
      });

      initStars();

      let resizeTimer;
      window.addEventListener("resize", () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => {
          buildClockFace();
          updateClock();
        }, 200);
      });
    }

    init();
  </script>
</body>
</html>
