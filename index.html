<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Toulon — Clock & Weather</title>
  <style>
    :root {
      --glass: rgba(16, 22, 40, 0.76);
      --glass-strong: rgba(14, 20, 40, 0.84);
      --border: rgba(255, 255, 255, 0.2);
      --text: #f5f7ff;
      --muted: #d4d9ee;
      --muted-strong: #e6ebf9;
      --accent: #7fe7ff;
      --accent-strong: #59d2ff;
      --accent-secondary: #b48cff;
      --shadow: 0 16px 36px rgba(0, 0, 0, 0.38);
      --card-radius: 18px;
      --card-gap: 16px;
      --blur: blur(22px);
      --glow: 0 0 30px rgba(116, 211, 255, 0.18);

      --icon-stroke: #d8dee9;
      --icon-cloud: #c7d1e2;
      --icon-rain: #86dcff;
      --icon-sun: #ffd36b;
      --icon-wind: #71e0e2;
      --icon-uv: #c79cff;
      --icon-humidity: #8acbff;
      --icon-pressure: #a9b4c8;
      --icon-night: #bda8ff;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      background: radial-gradient(circle at 12% 8%, #1a2750 0%, #0b1226 45%, #060812 100%);
      min-height: 100vh;
      overflow-x: hidden;
    }

    .galaxy {
      position: fixed;
      inset: 0;
      z-index: -2;
      background:
        radial-gradient(900px 520px at 78% 8%, rgba(120, 140, 255, 0.18), transparent 78%),
        radial-gradient(820px 440px at 12% 86%, rgba(255, 120, 200, 0.14), transparent 80%),
        radial-gradient(620px 380px at 48% 38%, rgba(110, 230, 255, 0.12), transparent 82%),
        radial-gradient(620px 360px at 22% 28%, rgba(210, 120, 255, 0.12), transparent 84%),
        radial-gradient(520px 300px at 72% 70%, rgba(255, 90, 90, 0.1), transparent 86%),
        radial-gradient(1200px 800px at 50% 50%, rgba(10, 14, 30, 0.9), rgba(5, 7, 16, 0.98));
      filter: saturate(1.1);
    }

    canvas#stars {
      position: fixed;
      inset: 0;
      z-index: -1;
      opacity: 0.55;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 28px;
    }

    .header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      margin-bottom: 18px;
      gap: 12px;
    }

    .title {
      font-size: 1.45rem;
      font-weight: 600;
      letter-spacing: 0.4px;
    }

    .last-updated {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.18);
      border: 1px solid rgba(255, 255, 255, 0.26);
      color: var(--muted-strong);
      font-size: 0.9rem;
      font-weight: 650;
      letter-spacing: 0.2px;
      white-space: nowrap;
      box-shadow: inset 0 0 12px rgba(255, 255, 255, 0.06);
    }

    .last-updated svg {
      width: 16px;
      height: 16px;
      color: var(--accent-strong);
    }

    .last-updated span {
      color: var(--accent);
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1fr) minmax(0, 0.9fr);
      gap: 24px;
      align-items: start;
    }

    .right-col {
      width: 100%;
      max-width: 560px;
      margin-left: auto;
    }

    .card {
      background: var(--glass);
      border: 1px solid var(--border);
      border-radius: var(--card-radius);
      box-shadow: var(--shadow);
      backdrop-filter: var(--blur);
      -webkit-backdrop-filter: var(--blur);
      padding: 18px 20px;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      min-height: 96px;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 34px rgba(0, 0, 0, 0.32);
    }

    .left-col .card + .card { margin-top: var(--card-gap); }

    .clock-wrap {
      display: grid;
      place-items: center;
      gap: 14px;
    }

    .analog {
      width: 230px;
      height: 230px;
      border-radius: 50%;
      background: radial-gradient(circle at 50% 40%, rgba(255,255,255,0.16), rgba(255,255,255,0.03));
      border: 1px solid rgba(255,255,255,0.28);
      position: relative;
      box-shadow: var(--glow), inset 0 0 18px rgba(255, 255, 255, 0.08);
    }

    .tick {
      position: absolute;
      width: 2px;
      height: 11px;
      background: rgba(255,255,255,0.5);
      top: 6px;
      left: 50%;
      transform-origin: 50% 110px;
    }

    .tick.major {
      height: 18px;
      background: rgba(255,255,255,0.9);
    }

    .hand {
      position: absolute;
      left: 50%;
      top: 50%;
      transform-origin: 0% 50%;
      transform: rotate(90deg);
      border-radius: 6px;
      transition: transform 0.4s cubic-bezier(0.4, 0.8, 0.2, 1);
    }

    .hand.hour {
      width: 64px;
      height: 6px;
      background: linear-gradient(90deg, #ffffff, #8cd6ff);
      box-shadow: 0 0 8px rgba(140, 214, 255, 0.35);
    }

    .hand.minute {
      width: 96px;
      height: 4px;
      background: linear-gradient(90deg, #ffffff, #bfeaff);
      box-shadow: 0 0 8px rgba(140, 214, 255, 0.28);
    }

    .hand.second {
      width: 108px;
      height: 2px;
      background: var(--accent-secondary);
      box-shadow: 0 0 10px rgba(180, 140, 255, 0.4);
      transition: transform 0.15s linear;
    }

    .center-dot {
      position: absolute;
      width: 11px;
      height: 11px;
      background: #fff;
      border-radius: 50%;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      box-shadow: 0 0 10px rgba(255,255,255,0.5);
    }

    .clock-number {
      position: absolute;
      font-size: 0.95rem;
      color: #f0f3ff;
      font-weight: 650;
      letter-spacing: 0.4px;
      transform: translate(-50%, -50%);
      user-select: none;
      pointer-events: none;
      text-shadow: 0 2px 6px rgba(9, 12, 24, 0.6);
    }

    .digital { text-align: center; }

    .digital-time {
      font-size: 2.6rem;
      font-weight: 700;
      letter-spacing: 2px;
      color: var(--accent);
    }

    .digital-time .seconds {
      font-size: 1.4rem;
      color: var(--muted);
    }

    .blink {
      display: inline-block;
      animation: blink 1s infinite ease-in-out;
    }

    @keyframes blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0.2; }
    }

    .digital-date {
      margin-top: 6px;
      color: var(--muted);
      font-size: 1rem;
    }

    .sun-moon {
      display: grid;
      gap: 10px;
    }

    .sun-moon-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 0.95rem;
      color: var(--muted-strong);
      gap: 10px;
    }

    .sun-moon-label {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .moon-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 22px;
      height: 22px;
      margin-right: 4px;
      flex: 0 0 auto;
      color: var(--icon-night);
    }

    .moon-icon svg {
      width: 18px;
      height: 18px;
    }

    .mini-forecast { display: grid; gap: 12px; }

    .mini-forecast-row {
      display: grid;
      grid-template-columns: repeat(6, minmax(0, 1fr));
      gap: 10px;
      align-items: stretch;
    }

    .mini-item {
      display: grid;
      grid-template-rows: auto 1fr auto auto;
      justify-items: center;
      gap: 6px;
      padding: 12px 8px 10px;
      border-radius: 14px;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.14);
      text-align: center;
    }

    .mini-icon {
      display: grid;
      place-items: center;
      width: 36px;
      height: 36px;
    }

    .mini-icon svg {
      width: 28px;
      height: 28px;
    }

    .mini-time {
      font-size: 0.75rem;
      color: var(--muted-strong);
      font-weight: 600;
      white-space: nowrap;
    }

    .mini-temp {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--accent);
    }

    .mini-precip {
      font-size: 0.7rem;
      color: var(--accent-secondary);
    }

    .mini-marker {
      font-size: 0.62rem;
      color: #ffd36b;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.4px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(255, 211, 107, 0.14);
      border: 1px solid rgba(255, 211, 107, 0.3);
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: var(--card-gap);
    }

    .weather-card {
      display: grid;
      gap: 6px;
      align-content: center;
    }

    .weather-title {
      font-size: 0.9rem;
      color: var(--muted-strong);
      letter-spacing: 0.2px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      text-transform: uppercase;
      font-weight: 600;
    }

    .weather-subtitle {
      font-size: 0.8rem;
      color: var(--muted);
      letter-spacing: 0.2px;
      font-weight: 500;
      text-transform: none;
    }

    .weather-value {
      font-size: 1.6rem;
      font-weight: 600;
      color: var(--accent);
    }

    .condition-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .condition-text {
      font-weight: 600;
      font-size: 1.05rem;
      color: var(--accent);
    }

    .metric-icon {
      width: 18px;
      height: 18px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: var(--icon-stroke);
      flex: 0 0 auto;
    }

    .metric-icon svg { width: 18px; height: 18px; }

    .metric-icon.sun { color: var(--icon-sun); }
    .metric-icon.cloud { color: var(--icon-cloud); }
    .metric-icon.rain { color: var(--icon-rain); }
    .metric-icon.wind { color: var(--icon-wind); }
    .metric-icon.uv { color: var(--icon-uv); }
    .metric-icon.humidity { color: var(--icon-humidity); }
    .metric-icon.pressure { color: var(--icon-pressure); }
    .metric-icon.night { color: var(--icon-night); }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.7rem;
      font-weight: 600;
      background: rgba(127, 231, 255, 0.18);
      border: 1px solid rgba(127, 231, 255, 0.45);
      color: var(--accent);
      white-space: nowrap;
    }

    .badge.hidden { display: none; }

    .wind-direction {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.85rem;
      color: var(--muted-strong);
      margin-top: 4px;
    }

    .wind-arrow {
      width: 18px;
      height: 18px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transform-origin: center;
    }

    .wind-arrow svg { width: 16px; height: 16px; }

    .sparkline { width: 100%; height: 80px; }

    .sparkline path,
    .sparkline polyline {
      fill: none;
      stroke-width: 2;
    }

    .sparkline .temp { stroke: #74d3ff; }

    .sparkline .precip {
      stroke: #7bdcff;
      stroke-dasharray: 2 3;
      opacity: 0.6;
    }

    .footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 18px;
      gap: 12px;
    }

    .signature {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      opacity: 0.9;
      font-weight: 600;
      letter-spacing: 0.3px;
      color: var(--muted-strong);
      padding: 8px 16px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.18);
      border: 1px solid rgba(255, 255, 255, 0.26);
      white-space: nowrap;
      box-shadow: inset 0 0 12px rgba(255, 255, 255, 0.06);
    }

    .signature-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--accent-secondary);
      box-shadow: 0 0 8px rgba(180, 140, 255, 0.6);
    }

    .refresh-btn {
      background: rgba(255,255,255,0.12);
      border: 1px solid rgba(255,255,255,0.2);
      color: var(--text);
      padding: 6px 12px;
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.2s ease;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .refresh-btn:hover { background: rgba(255,255,255,0.2); }

    .status-card {
      display: grid;
      gap: 6px;
      color: var(--muted-strong);
    }

    .status-title {
      font-weight: 600;
      color: var(--accent-secondary);
    }

    .status-details {
      font-size: 0.85rem;
      color: var(--muted);
    }

    @media (max-width: 900px) {
      .layout { grid-template-columns: 1fr; }
      .grid { grid-template-columns: 1fr; }
      .right-col { max-width: 100%; margin-left: 0; }
      .analog { width: 210px; height: 210px; }
      .mini-forecast-row { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    }
  </style>
</head>
<body>
  <div class="galaxy"></div>
  <canvas id="stars"></canvas>

  <div class="container">
    <div class="header">
      <div class="title">Toulon, France</div>
      <div class="last-updated">
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <circle cx="12" cy="12" r="8" stroke="currentColor" stroke-width="1.6"/>
          <path d="M12 7v5l3 2" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        Last updated at <span id="lastUpdated">--:--</span>
      </div>
    </div>

    <div class="layout">
      <div class="left-col">
        <div class="card clock-wrap">
          <div class="analog" id="analogClock"></div>
          <div class="digital">
            <div class="digital-time">
              <span id="hh">00</span><span class="blink">:</span><span id="mm">00</span>
              <span class="seconds">:<span id="ss">00</span></span>
            </div>
            <div class="digital-date" id="dateString">--</div>
          </div>
        </div>

        <div class="card sun-moon">
          <div class="sun-moon-row">
            <div>Sunrise</div>
            <div id="sunrise">--:--</div>
          </div>
          <div class="sun-moon-row">
            <div>Sunset</div>
            <div id="sunset">--:--</div>
          </div>
          <div class="sun-moon-row">
            <div class="sun-moon-label">
              <span class="moon-icon" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none">
                  <path d="M16 4a8 8 0 1 0 4 14.2A7.2 7.2 0 0 1 16 4z"
                        stroke="currentColor" stroke-width="1.5"
                        stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </span>
              Moon phase
            </div>
            <div id="moonPhase">--</div>
          </div>
        </div>

        <div class="card mini-forecast">
          <div class="weather-title">Next 6 hours</div>
          <div class="mini-forecast-row" id="miniForecast"></div>
        </div>
      </div>

      <div class="right-col">
        <div class="grid">
          <div class="card weather-card">
            <div class="weather-title">
              <span class="metric-icon cloud" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none">
                  <path d="M6 16h10a4 4 0 0 0 0-8 6 6 0 0 0-11.2 1.8A3.5 3.5 0 0 0 6 16z"
                        stroke="currentColor" stroke-width="1.8"
                        stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </span>
              Conditions
            </div>
            <div class="condition-row">
              <div id="conditionIcon"></div>
              <div class="condition-text" id="conditionText">--</div>
            </div>
          </div>

          <div class="card weather-card">
            <div class="weather-title">
              <span class="metric-icon sun" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none">
                  <circle cx="12" cy="12" r="4" stroke="currentColor" stroke-width="1.8"/>
                  <path d="M12 2v2M12 20v2M2 12h2M20 12h2M4.8 4.8l1.4 1.4M17.8 17.8l1.4 1.4M4.8 19.2l1.4-1.4M17.8 6.2l1.4-1.4"
                        stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                </svg>
              </span>
              Temperature
            </div>
            <div class="weather-value" id="temp">--°C</div>
            <div class="weather-subtitle">Feels like <span id="feels">--°C</span></div>
          </div>

          <div class="card weather-card">
            <div class="weather-title">
              <span class="metric-icon humidity" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none">
                  <path d="M12 3s5 6 5 9a5 5 0 1 1-10 0c0-3 5-9 5-9z"
                        stroke="currentColor" stroke-width="1.8"
                        stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </span>
              Humidity
            </div>
            <div class="weather-value" id="humidity">--%</div>
            <div class="weather-subtitle">Dew point <span id="dewPoint">--°C</span></div>
          </div>

          <div class="card weather-card">
            <div class="weather-title">
              <span class="metric-icon pressure" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none">
                  <circle cx="12" cy="12" r="8" stroke="currentColor" stroke-width="1.8"/>
                  <path d="M12 12l3-4" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                </svg>
              </span>
              Pressure
            </div>
            <div class="weather-value" id="pressure">-- hPa</div>
          </div>

          <div class="card weather-card">
            <div class="weather-title">
              <span class="metric-icon wind" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none">
                  <path d="M4 9h10a3 3 0 1 0-3-3" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                  <path d="M4 14h12a2.5 2.5 0 1 1-2.5 2.5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                </svg>
              </span>
              Wind
            </div>
            <div class="weather-value" id="wind">-- km/h</div>
            <div class="weather-subtitle">
              Gusts <span id="gusts">-- km/h</span> <span class="badge hidden" id="gustAlert">High</span>
            </div>
            <div class="wind-direction">
              <span class="wind-arrow" id="windArrow" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none">
                  <path d="M12 4l4 6h-8l4-6z" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/>
                  <path d="M12 10v8" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                </svg>
              </span>
              <span id="windDir">--</span>
            </div>
          </div>

          <div class="card weather-card">
            <div class="weather-title">
              <span class="metric-icon uv" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none">
                  <circle cx="12" cy="12" r="7" stroke="currentColor" stroke-width="1.8"/>
                  <path d="M12 5v2M12 17v2M5 12h2M17 12h2" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                </svg>
              </span>
              UV index <span class="badge hidden" id="uvAlert">High</span>
            </div>
            <div class="weather-value" id="uv">--</div>
          </div>

          <div class="card weather-card">
            <div class="weather-title">
              <span class="metric-icon night" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none">
                  <path d="M14 4a7 7 0 1 0 6 12A8 8 0 0 1 14 4z"
                        stroke="currentColor" stroke-width="1.8"
                        stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </span>
              Visibility
            </div>
            <div class="weather-value" id="visibility">-- km</div>
          </div>

          <div class="card weather-card">
            <div class="weather-title">
              <span class="metric-icon cloud" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none">
                  <path d="M6 16h10a4 4 0 0 0 0-8 6 6 0 0 0-11.2 1.8A3.5 3.5 0 0 0 6 16z"
                        stroke="currentColor" stroke-width="1.8"
                        stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </span>
              Cloud cover
            </div>
            <div class="weather-value" id="clouds">--%</div>
          </div>

          <div class="card weather-card">
            <div class="weather-title">
              <span class="metric-icon rain" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none">
                  <path d="M6 12h10a4 4 0 0 0 0-8 6 6 0 0 0-11.2 1.8A3.5 3.5 0 0 0 6 12z"
                        stroke="currentColor" stroke-width="1.8"
                        stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M8 16l-1 3M12 16l-1 3M16 16l-1 3"
                        stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                </svg>
              </span>
              Precipitation probability
            </div>
            <div class="weather-value" id="precipProb">--%</div>
          </div>

          <div class="card weather-card">
            <div class="weather-title">
              <span class="metric-icon rain" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none">
                  <path d="M6 12h10a4 4 0 0 0 0-8 6 6 0 0 0-11.2 1.8A3.5 3.5 0 0 0 6 12z"
                        stroke="currentColor" stroke-width="1.8"
                        stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M12 15v4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                </svg>
              </span>
              Rain rate
            </div>
            <div class="weather-value" id="rainRate">0.0 mm per hour</div>
          </div>

          <div class="card weather-card">
            <div class="weather-title">
              <span class="metric-icon wind" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none">
                  <path d="M4 11h12a3 3 0 1 0-3-3" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                  <path d="M4 15h10a2.5 2.5 0 1 1-2.5 2.5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                </svg>
              </span>
              Air quality <span class="badge hidden" id="aqiAlert">Poor</span>
            </div>
            <div class="weather-value" id="airQuality">Not available</div>
          </div>

          <div class="card weather-card">
            <div class="weather-title">
              <span class="metric-icon sun" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none">
                  <path d="M5 12h14" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                  <path d="M12 5v14" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/>
                </svg>
              </span>
              24h outlook
            </div>
            <svg class="sparkline" viewBox="0 0 300 80">
              <polyline id="tempLine" class="temp" points=""></polyline>
              <polyline id="precipLine" class="precip" points=""></polyline>
            </svg>
            <div class="weather-subtitle">Mini temp curve + precip probability</div>
          </div>
        </div>

        <div class="card" id="statusCard" style="margin-top: var(--card-gap); display:none;">
          <div class="status-card">
            <div class="status-title">Weather temporarily unavailable</div>
            <div class="status-details" id="statusDetails">Trying again soon.</div>
          </div>
        </div>
      </div>
    </div>

    <div class="footer">
      <div class="signature"><span class="signature-dot" aria-hidden="true"></span>B. Geeverding</div>
      <button class="refresh-btn" id="refreshBtn">Refresh</button>
    </div>
  </div>

  <script>
    const CITY = "Toulon";
    const LAT = 43.1242;
    const LON = 5.9280;
    const TZ = "Europe/Paris";
    const REFRESH_MS = 10 * 60 * 1000;

    const state = {
      weather: null,
      air: null
    };

    const $ = (id) => document.getElementById(id);

    function formatValue(value, formatter, fallback = "--") {
      if (!Number.isFinite(value)) return fallback;
      return formatter(value);
    }

    function formatTimeHMFromParts(parts) {
      return `${parts.hour}:${parts.minute}`;
    }

    function formatDateLongFromParts(parts) {
      return `${parts.weekday}, ${parts.day} ${parts.month} ${parts.year}`;
    }

    function splitLocalTime(timeString) {
      if (!timeString) return null;
      const [, timePart] = timeString.split("T");
      if (!timePart) return null;
      const [hour, minute] = timePart.split(":");
      return { hour, minute };
    }

    function formatTimeHMFromString(timeString) {
      const parts = splitLocalTime(timeString);
      if (!parts) return "--:--";
      return `${parts.hour}:${parts.minute}`;
    }

    function getParisParts(date = new Date()) {
      const formatter = new Intl.DateTimeFormat("en-GB", {
        timeZone: TZ,
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit",
        fractionalSecondDigits: 3,
        weekday: "long",
        year: "numeric",
        month: "long",
        day: "2-digit",
        hour12: false
      });

      const parts = formatter.formatToParts(date).reduce((acc, part) => {
        acc[part.type] = part.value;
        return acc;
      }, {});

      return parts;
    }

    function getParisDateObject(parts) {
      const monthIndex = new Date(`${parts.month} 1, 2000`).getMonth();
      return new Date(Date.UTC(
        Number(parts.year),
        monthIndex,
        Number(parts.day),
        Number(parts.hour),
        Number(parts.minute),
        Number(parts.second)
      ));
    }

    function fetchWithTimeout(url, timeout = 8000) {
      return new Promise((resolve, reject) => {
        const controller = new AbortController();
        const timer = setTimeout(() => controller.abort(), timeout);

        fetch(url, { signal: controller.signal })
          .then((res) => {
            clearTimeout(timer);
            if (!res.ok) throw new Error("HTTP " + res.status);
            return res.json();
          })
          .then(resolve)
          .catch(reject);
      });
    }

    async function fetchWithRetry(url, retries = 1) {
      try {
        return await fetchWithTimeout(url);
      } catch (e) {
        if (retries > 0) {
          await new Promise(r => setTimeout(r, 800));
          return fetchWithRetry(url, retries - 1);
        }
        throw e;
      }
    }

    function setDataUnavailable(show) {
      const card = $("statusCard");
      card.style.display = show ? "block" : "none";

      if (show) {
        const lastTime = state.weather?.current?.time;
        $("statusDetails").textContent = lastTime
          ? `Last known update ${formatTimeHMFromString(lastTime)}.`
          : "Trying again soon.";
      }
    }

    function weatherLabel(code) {
      const map = {
        0: "Clear",
        1: "Mainly clear",
        2: "Partly cloudy",
        3: "Overcast",
        45: "Fog",
        48: "Depositing rime fog",
        51: "Light drizzle",
        53: "Drizzle",
        55: "Dense drizzle",
        61: "Light rain",
        63: "Rain",
        65: "Heavy rain",
        66: "Freezing rain",
        67: "Heavy freezing rain",
        71: "Light snow",
        73: "Snow",
        75: "Heavy snow",
        77: "Snow grains",
        80: "Rain showers",
        81: "Heavy showers",
        82: "Violent showers",
        85: "Snow showers",
        86: "Heavy snow showers",
        95: "Thunderstorm",
        96: "Thunderstorm with hail",
        99: "Thunderstorm with heavy hail"
      };
      return map[code] || "Unknown";
    }

    function weatherIcon(code) {
      const stroke = "#d8dee9";
      const strokeSoft = "#c7cfdd";
      const sun = "#ffd36b";
      const rain = "#7bdcff";
      const night = "#bda8ff";

      if ([0, 1].includes(code)) {
        return `<svg width="40" height="40" viewBox="0 0 64 64" fill="none" stroke="${stroke}" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="32" cy="32" r="10" stroke="${sun}" />
          <path d="M32 6v8M32 50v8M6 32h8M50 32h8M14 14l6 6M44 44l6 6M14 50l6-6M44 20l6-6" stroke="${sun}" />
        </svg>`;
      }

      if ([2].includes(code)) {
        return `<svg width="40" height="40" viewBox="0 0 64 64" fill="none" stroke="${strokeSoft}" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="22" cy="22" r="8" stroke="${sun}" />
          <path d="M18 42h26a10 10 0 0 0 0-20 14 14 0 0 0-27-2A10 10 0 0 0 18 42z" />
        </svg>`;
      }

      if ([3].includes(code)) {
        return `<svg width="40" height="40" viewBox="0 0 64 64" fill="none" stroke="${strokeSoft}" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M16 40h30a10 10 0 0 0 0-20 14 14 0 0 0-27-2A10 10 0 0 0 16 40z" />
        </svg>`;
      }

      if ([45, 48].includes(code)) {
        return `<svg width="40" height="40" viewBox="0 0 64 64" fill="none" stroke="${strokeSoft}" stroke-width="2.2" stroke-linecap="round">
          <path d="M12 26h40" />
          <path d="M8 36h48" />
          <path d="M16 46h32" />
        </svg>`;
      }

      if ([51, 53, 55, 61, 63, 65, 80, 81, 82].includes(code)) {
        return `<svg width="40" height="40" viewBox="0 0 64 64" fill="none" stroke="${strokeSoft}" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M16 34h30a10 10 0 0 0 0-20 14 14 0 0 0-27-2A10 10 0 0 0 16 34z" />
          <path d="M22 42l-4 8" stroke="${rain}" />
          <path d="M34 42l-4 8" stroke="${rain}" />
          <path d="M46 42l-4 8" stroke="${rain}" />
        </svg>`;
      }

      if ([71, 73, 75, 77, 85, 86].includes(code)) {
        return `<svg width="40" height="40" viewBox="0 0 64 64" fill="none" stroke="${strokeSoft}" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M16 34h30a10 10 0 0 0 0-20 14 14 0 0 0-27-2A10 10 0 0 0 16 34z" />
          <circle cx="22" cy="44" r="2" />
          <circle cx="34" cy="46" r="2" />
          <circle cx="46" cy="44" r="2" />
        </svg>`;
      }

      if ([95, 96, 99].includes(code)) {
        return `<svg width="40" height="40" viewBox="0 0 64 64" fill="none" stroke="${strokeSoft}" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M16 32h30a10 10 0 0 0 0-20 14 14 0 0 0-27-2A10 10 0 0 0 16 32z" />
          <path d="M30 36l-6 12h8l-4 10 12-14h-8l4-8z" stroke="${night}" />
        </svg>`;
      }

      return `<svg width="40" height="40" viewBox="0 0 64 64" fill="none" stroke="${stroke}" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="32" cy="32" r="10" />
        <path d="M26 32h12" />
      </svg>`;
    }

    function moonPhaseName(date) {
      const lp = 2551443;
      const newMoon = new Date("2001-01-24T13:35:00Z").getTime() / 1000;
      const now = date.getTime() / 1000;
      const phase = ((now - newMoon) % lp) / lp;

      if (phase < 0.03 || phase > 0.97) return "New Moon";
      if (phase < 0.22) return "Waxing Crescent";
      if (phase < 0.28) return "First Quarter";
      if (phase < 0.47) return "Waxing Gibbous";
      if (phase < 0.53) return "Full Moon";
      if (phase < 0.72) return "Waning Gibbous";
      if (phase < 0.78) return "Last Quarter";
      return "Waning Crescent";
    }

    function buildTicks() {
      const clock = $("analogClock");
      const size = clock.clientWidth || 230;
      const center = size / 2;

      for (let i = 0; i < 60; i++) {
        const t = document.createElement("div");
        t.className = "tick" + (i % 5 === 0 ? " major" : "");
        t.style.transform = `rotate(${i * 6}deg) translateX(-50%)`;
        t.style.transformOrigin = `50% ${center - 5}px`;
        clock.appendChild(t);
      }

      const numbers = [
        { text: "12", angle: 0 },
        { text: "3", angle: 90 },
        { text: "6", angle: 180 },
        { text: "9", angle: 270 }
      ];

      numbers.forEach(({ text, angle }) => {
        const num = document.createElement("div");
        num.className = "clock-number";

        const radius = center - 28;
        const rad = (angle - 90) * (Math.PI / 180);
        const x = center + radius * Math.cos(rad);
        const y = center + radius * Math.sin(rad);

        num.style.left = `${x}px`;
        num.style.top = `${y}px`;
        num.textContent = text;

        clock.appendChild(num);
      });

      const hour = document.createElement("div");
      hour.className = "hand hour";

      const minute = document.createElement("div");
      minute.className = "hand minute";

      const second = document.createElement("div");
      second.className = "hand second";

      const dot = document.createElement("div");
      dot.className = "center-dot";

      clock.appendChild(hour);
      clock.appendChild(minute);
      clock.appendChild(second);
      clock.appendChild(dot);
    }

    function updateClock() {
      const parts = getParisParts();

      $("hh").textContent = parts.hour;
      $("mm").textContent = parts.minute;
      $("ss").textContent = parts.second;
      $("dateString").textContent = formatDateLongFromParts(parts);

      const hour = Number(parts.hour);
      const minute = Number(parts.minute);
      const second = Number(parts.second);
      const milli = Number(parts.fractionalSecond || 0);

      const secFloat = second + milli / 1000;
      const hourDeg = (hour % 12) * 30 + minute * 0.5 + secFloat / 120;
      const minDeg = minute * 6 + secFloat * 0.1;
      const secDeg = secFloat * 6;

      const hands = document.querySelectorAll(".hand");
      hands[0].style.transform = `rotate(${hourDeg - 90}deg)`;
      hands[1].style.transform = `rotate(${minDeg - 90}deg)`;
      hands[2].style.transform = `rotate(${secDeg - 90}deg)`;

      const parisDate = getParisDateObject(parts);
      $("moonPhase").textContent = moonPhaseName(parisDate);
    }

    async function loadWeather() {
      const url =
        `https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}` +
        `&current=temperature_2m,apparent_temperature,relative_humidity_2m,dew_point_2m,pressure_msl,wind_speed_10m,wind_gusts_10m,wind_direction_10m,cloud_cover,visibility,precipitation,precipitation_probability,weather_code,uv_index,is_day,rain` +
        `&hourly=temperature_2m,precipitation_probability,precipitation,weather_code` +
        `&daily=sunrise,sunset` +
        `&timezone=${encodeURIComponent(TZ)}`;

      try {
        const data = await fetchWithRetry(url, 1);
        state.weather = data;
        renderWeather(data);
        setDataUnavailable(false);

        const parts = getParisParts();
        $("lastUpdated").textContent = formatTimeHMFromParts(parts);
      } catch (e) {
        setDataUnavailable(true);
      }
    }

    async function loadAirQuality() {
      const url = `https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${LAT}&longitude=${LON}&current=us_aqi&timezone=${encodeURIComponent(TZ)}`;
      try {
        const data = await fetchWithRetry(url, 1);
        state.air = data;
        renderAirQuality(data);
      } catch (e) {
        if (!state.air) $("airQuality").textContent = "Not available";
      }
    }

    function renderAirQuality(data) {
      const aqi = data?.current?.us_aqi;
      if (aqi == null) {
        $("airQuality").textContent = "Not available";
        return;
      }

      $("airQuality").textContent = `${aqi} AQI`;

      if (state.weather?.current) updateAlerts(state.weather.current);
    }

    function renderWeather(data) {
      const c = data.current;
      if (!c) return;

      $("temp").textContent = formatValue(c.temperature_2m, (v) => `${Math.round(v)}°C`);
      $("feels").textContent = formatValue(c.apparent_temperature, (v) => `${Math.round(v)}°C`);
      $("humidity").textContent = formatValue(c.relative_humidity_2m, (v) => `${Math.round(v)}%`);
      $("dewPoint").textContent = formatValue(c.dew_point_2m, (v) => `${Math.round(v)}°C`);
      $("pressure").textContent = formatValue(c.pressure_msl, (v) => `${Math.round(v)} hPa`);
      $("wind").textContent = formatValue(c.wind_speed_10m, (v) => `${Math.round(v)} km/h`);
      $("gusts").textContent = formatValue(c.wind_gusts_10m, (v) => `${Math.round(v)} km/h`);
      $("uv").textContent = formatValue(c.uv_index, (v) => `${Math.round(v)}`);
      $("visibility").textContent = formatValue(c.visibility, (v) => `${(v / 1000).toFixed(1)} km`);
      $("clouds").textContent = formatValue(c.cloud_cover, (v) => `${Math.round(v)}%`);
      $("precipProb").textContent = formatValue(c.precipitation_probability, (v) => `${Math.round(v)}%`);

      const rainRateRaw = c.rain ?? c.precipitation;
      const rainRate = Number.isFinite(rainRateRaw) ? rainRateRaw : 0;
      $("rainRate").textContent = `${rainRate.toFixed(1)} mm per hour`;

      const code = Number.isFinite(c.weather_code) ? c.weather_code : null;
      $("conditionText").textContent = code != null ? weatherLabel(code) : "--";
      $("conditionIcon").innerHTML = weatherIcon(code ?? -1);

      const sunrise = data.daily?.sunrise?.[0];
      const sunset = data.daily?.sunset?.[0];
      $("sunrise").textContent = sunrise ? formatTimeHMFromString(sunrise) : "--:--";
      $("sunset").textContent = sunset ? formatTimeHMFromString(sunset) : "--:--";

      const windDir = Number.isFinite(c.wind_direction_10m) ? c.wind_direction_10m : null;
      updateWindDirection(windDir);
      updateAlerts(c);

      renderSparkline(data);
      renderMiniForecast(data);
    }

    function renderSparkline(data) {
      const temps = data.hourly?.temperature_2m?.slice(0, 24) || [];
      const probs = data.hourly?.precipitation_probability?.slice(0, 24) || [];
      if (!temps.length) return;

      const tempMin = Math.min(...temps);
      const tempMax = Math.max(...temps);
      const width = 300;
      const height = 80;

      const tempPoints = temps.map((t, i) => {
        const x = (i / (temps.length - 1)) * width;
        const y = height - ((t - tempMin) / (tempMax - tempMin || 1)) * (height - 10) - 5;
        return `${x},${y}`;
      }).join(" ");

      const probPoints = probs.map((p, i) => {
        const x = (i / (probs.length - 1)) * width;
        const y = height - (p / 100) * (height - 10) - 5;
        return `${x},${y}`;
      }).join(" ");

      $("tempLine").setAttribute("points", tempPoints);
      $("precipLine").setAttribute("points", probPoints);
    }

    function renderMiniForecast(data) {
      const container = $("miniForecast");
      container.innerHTML = "";

      const times = data.hourly?.time || [];
      const temps = data.hourly?.temperature_2m || [];
      const probs = data.hourly?.precipitation_probability || [];
      const codes = data.hourly?.weather_code || [];

      const sunrise = data.daily?.sunrise?.[0] || null;
      const currentTime = data.current?.time;

      if (!currentTime || !times.length) return;

      const startIndex = times.findIndex((t) => t === currentTime);
      const index = startIndex >= 0 ? startIndex : 0;

      const sliceTimes = times.slice(index, index + 6);

      sliceTimes.forEach((time, i) => {
        const timeParts = splitLocalTime(time);
        const label = i === 0 ? "Now" : (timeParts ? `${timeParts.hour}h` : "--");

        const temp = temps[index + i];
        const prob = probs[index + i];
        const code = codes[index + i];
        const tempLabel = Number.isFinite(temp) ? `${Math.round(temp)}°` : "--";
        const probLabel = Number.isFinite(prob) ? `${Math.round(prob)}%` : "--";

        const item = document.createElement("div");
        item.className = "mini-item";
        item.innerHTML = `
          <div class="mini-time">${label}</div>
          <div class="mini-icon">${weatherIcon(code)}</div>
          <div class="mini-temp">${tempLabel}</div>
          <div class="mini-precip">${probLabel}</div>
        `;

        if (sunrise) {
          const sunriseParts = splitLocalTime(sunrise);
          if (sunriseParts && timeParts && sunriseParts.hour === timeParts.hour) {
            const marker = document.createElement("div");
            marker.className = "mini-marker";
            marker.textContent = "Sunrise";
            item.appendChild(marker);
          }
        }

        container.appendChild(item);
      });
    }

    function updateAlerts(current) {
      const uvAlert = $("uvAlert");
      const gustAlert = $("gustAlert");
      const aqiAlert = $("aqiAlert");

      const uvValue = Number(current.uv_index);
      const gustValue = Number(current.wind_gusts_10m);

      uvAlert.classList.toggle("hidden", !(uvValue > 6));
      gustAlert.classList.toggle("hidden", !(gustValue > 40));

      if (state.air?.current?.us_aqi != null) {
        aqiAlert.classList.toggle("hidden", !(Number(state.air.current.us_aqi) > 100));
      } else {
        aqiAlert.classList.add("hidden");
      }
    }

    function degToCompass(deg) {
      if (!Number.isFinite(deg)) return "--";
      const directions = ["N", "NE", "E", "SE", "S", "SW", "W", "NW"];
      const index = Math.round(((deg % 360) / 45)) % 8;
      return directions[index];
    }

    function updateWindDirection(deg) {
      const arrow = $("windArrow");
      if (!Number.isFinite(deg)) {
        $("windDir").textContent = "--";
        arrow.style.transform = "rotate(0deg)";
        return;
      }
      arrow.style.transform = `rotate(${deg}deg)`;
      $("windDir").textContent = `${degToCompass(deg)} • ${Math.round(deg)}°`;
    }

    function initStars() {
      const canvas = $("stars");
      const ctx = canvas.getContext("2d");

      let w, h;
      const stars = Array.from({ length: 80 }, () => ({
        x: Math.random(),
        y: Math.random(),
        r: Math.random() * 1.2 + 0.2,
        alpha: Math.random() * 0.6 + 0.2,
        drift: (Math.random() - 0.5) * 0.00015
      }));

      function resize() {
        w = canvas.width = window.innerWidth;
        h = canvas.height = window.innerHeight;
      }

      window.addEventListener("resize", resize);
      resize();

      function draw() {
        ctx.clearRect(0, 0, w, h);
        for (const s of stars) {
          s.y += s.drift;
          if (s.y < 0) s.y = 1;
          if (s.y > 1) s.y = 0;

          ctx.beginPath();
          ctx.fillStyle = `rgba(255,255,255,${s.alpha})`;
          ctx.arc(s.x * w, s.y * h, s.r, 0, Math.PI * 2);
          ctx.fill();
        }
        requestAnimationFrame(draw);
      }

      draw();
    }

    function init() {
      document.querySelector(".title").textContent = `${CITY}, France`;

      buildTicks();
      updateClock();
      setInterval(updateClock, 1000);

      loadWeather();
      loadAirQuality();
      setInterval(loadWeather, REFRESH_MS);
      setInterval(loadAirQuality, REFRESH_MS);

      $("refreshBtn").addEventListener("click", () => {
        loadWeather();
        loadAirQuality();
      });

      initStars();
    }

    init();
  </script>
</body>
</html>
